import{J as M,r as c,j as t,Q as A,B as p,s as m,a as x}from"./app-Cq9T9vxM.js";import{A as Y,b as q}from"./AdminLayout-CqQNNgQt.js";import{d as z}from"./dayjs.min-BTLK4jSO.js";import{f as B}from"./khmerDate-iNtMyZoL.js";import{F as n}from"./index-UraXu45p.js";import{C as j,R as Q}from"./index-0lybEGve.js";import{S as G}from"./index-DplbXNQy.js";import{T as H}from"./index-B236O7Xl.js";import{D as g}from"./index-CYTdZQrd.js";import{R as J}from"./DeleteOutlined-j2tGMUPF.js";import{I as K}from"./index-DHD7yk2W.js";import{T as _}from"./index-DBk7DIQb.js";import{D as O}from"./index-CKm1mZ_X.js";import{R as U}from"./UserOutlined-BJz0bsFe.js";import{R as V}from"./EnvironmentOutlined-CY7V_ekf.js";import{R as W}from"./DollarOutlined-CBIm1o3u.js";import{R as X}from"./FileOutlined-azBO8rMn.js";import"./index-DL0uTJIv.js";import"./index-DPFVXnL-.js";import"./EllipsisOutlined-BDh9HHBq.js";import"./PurePanel-Ce8hDmce.js";import"./index-B5_NNnDd.js";import"./InboxOutlined-ZSWvT0kT.js";import"./row-CJ-aj50t.js";import"./useVariants-Ea3XEG1D.js";import"./CheckOutlined-_L7buK6x.js";import"./progress-CdXVhW7a.js";import"./EditOutlined-BcDUZ6EU.js";import"./getAllowClear-nqy4kNbo.js";import"./Input-DONKCjvs.js";import"./EyeOutlined-CFXJhbVH.js";import"./SearchOutlined-PK94XR1x.js";import"./DownOutlined-8JSIA4HI.js";import"./CalendarOutlined-CimjgQ7W.js";import"./ClockCircleOutlined-CuqZA4f1.js";import"./useIcons-Ds0_kiqE.js";const{Title:y,Text:d}=H;function Te({document:o,paymentSteps:b,editMode:S}){const{csrf_token:f}=M().props,[v,h]=c.useState(!1),[$]=n.useForm(),[a,i]=c.useState(b||[{step_number:1,amount:"",due_date:null,payment_time_description:"",percentage:""}]),[l,F]=c.useState(0),[w,N]=c.useState(!0);c.useEffect(()=>{let r=0,s=!1;a.forEach(e=>{e.amount&&(r+=parseFloat(e.amount)),(!e.amount||!e.due_date||!e.payment_time_description)&&(s=!0)}),F(r),N(s)},[a]);const I=()=>{const r=a.length+1;i([...a,{step_number:r,amount:"",due_date:null,payment_time_description:"",percentage:""}])},D=r=>{if(a.length<=1){m.error("យ៉ាងហោចណាស់ត្រូវមានដំណាក់កាលបង់ប្រាក់មួយ");return}const s=[...a];s.splice(r,1),s.forEach((e,u)=>{e.step_number=u+1}),i(s)},R=(r,s)=>{const e=[...a];e[r].amount=s,e[r].percentage="",i(e)},C=(r,s)=>{const e=[...a];if(e[r].percentage=s,s&&o.total_land_price){const u=parseFloat(s)/100*parseFloat(o.total_land_price);e[r].amount=u.toFixed(2)}else e[r].amount="";i(e)},L=(r,s)=>{const e=[...a];e[r].due_date=s?s.format("YYYY-MM-DD"):null,i(e)},P=(r,s)=>{const e=[...a];e[r].payment_time_description=s,i(e)},E=async()=>{if(a.some(e=>!e.amount||!e.due_date||!e.payment_time_description)){m.error("សូមបញ្ចូលចំនួនទឹកប្រាក់, កាលបរិច្ឆេទ និងពេលវេលាបង់ប្រាក់សម្រាប់ដំណាក់កាលទាំងអស់");return}const s=parseFloat(o.total_land_price);if(Math.abs(l-s)>.01){m.error(`ចំនួនទឹកប្រាក់សរុបត្រូវតែស្មើនឹងតម្លៃដីសរុប ($${s.toLocaleString()})`);return}h(!0);try{const e="sale-contracts";await x.post(`/api/${e}/${o.id}/payment-steps`,{payment_steps:a,_token:f}),await x.post(`/api/${e}/${o.id}/generate`,{_token:f}),window.location.href=route("sale-contracts.success",{id:o.id})}catch(e){console.error("បញ្ហាក្នុងការបង្កើតកិច្ចសន្យា:",e),e.response&&e.response.data&&e.response.data.error?m.error(e.response.data.error):m.error("មានបញ្ហាក្នុងការបង្កើតកិច្ចសន្យា")}finally{h(!1)}},T=3,k=[{title:"ជ្រើសរើសអ្នកទិញ",icon:t.jsx(U,{})},{title:"ជ្រើសរើសអ្នកលក់",icon:t.jsx(q,{})},{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ",icon:t.jsx(V,{})},{title:"ដំណាក់កាលបង់ប្រាក់",icon:t.jsx(W,{})},{title:"បង្កើតកិច្ចសន្យា",icon:t.jsx(X,{})}];return t.jsxs(Y,{children:[t.jsx(A,{title:"ដំណាក់កាលបង់ប្រាក់"}),t.jsxs("div",{className:"container mx-auto py-6",children:[t.jsx(j,{className:"mb-6",children:t.jsx(G,{current:T,items:k,responsive:!0,className:"site-navigation-steps",size:"small"})}),t.jsxs(j,{children:[t.jsx(y,{level:3,className:"mb-6",children:S?"កែសម្រួលដំណាក់កាលបង់ប្រាក់":"ដំណាក់កាលបង់ប្រាក់"}),t.jsx("div",{className:"mb-6",children:t.jsxs(d,{strong:!0,children:["តម្លៃដីសរុប: $",parseFloat(o.total_land_price).toLocaleString()]})}),t.jsx(g,{}),t.jsxs(n,{form:$,layout:"vertical",children:[a.map((r,s)=>t.jsxs("div",{className:"mb-8 p-4 border rounded-md bg-gray-50",children:[t.jsxs("div",{className:"flex justify-between items-center mb-4",children:[t.jsxs(y,{level:5,children:["ដំណាក់កាលទី ",r.step_number]}),t.jsx(p,{danger:!0,icon:t.jsx(J,{}),onClick:()=>D(s),disabled:a.length<=1})]}),t.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[t.jsx(n.Item,{label:"ពេលវេលាបង់ប្រាក់ (Payment Time Description)",required:!0,children:t.jsx(K,{value:r.payment_time_description,onChange:e=>P(s,e.target.value),placeholder:"បញ្ចូលពេលវេលាបង់ប្រាក់"})}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4",children:[t.jsx(n.Item,{label:"ភាគរយ (Percentage %)",children:t.jsx(_,{style:{width:"100%"},min:0,max:100,precision:2,suffix:"%",value:r.percentage,onChange:e=>C(s,e),placeholder:"បញ្ចូលភាគរយ"})}),t.jsx(n.Item,{label:"ចំនួនទឹកប្រាក់ (Amount)",required:!0,children:t.jsx(_,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:r.amount,onChange:e=>R(s,e),placeholder:"បញ្ចូលចំនួនទឹកប្រាក់"})}),t.jsx(n.Item,{label:"កាលបរិច្ឆេទត្រូវបង់ (Due Date)",required:!0,children:t.jsx(O,{style:{width:"100%"},value:r.due_date?z(r.due_date):null,onChange:e=>L(s,e),placeholder:"ជ្រើសរើសកាលបរិច្ឆេទ",format:e=>B(e)})})]}),r.percentage&&t.jsxs("div",{className:"text-sm text-gray-600 bg-blue-50 p-2 rounded",children:["គណនា: ",r.percentage,"% × $",parseFloat(o.total_land_price).toLocaleString()," = $",parseFloat(r.amount||0).toLocaleString()]})]})]},s)),t.jsx("div",{className:"text-center mb-6",children:t.jsx(p,{type:"dashed",icon:t.jsx(Q,{}),onClick:I,children:"បន្ថែមដំណាក់កាលបង់ប្រាក់"})})]}),t.jsx(g,{}),t.jsxs("div",{className:"flex justify-between items-center mb-6",children:[t.jsx(d,{strong:!0,children:"ចំនួនទឹកប្រាក់សរុប:"}),t.jsxs(d,{strong:!0,style:{fontSize:"1.2rem",color:Math.abs(l-parseFloat(o.total_land_price))>.01?"red":"green"},children:["$",l.toLocaleString()]})]}),Math.abs(l-parseFloat(o.total_land_price))>.01&&t.jsx("div",{className:"mb-6 p-2 bg-red-50 border border-red-200 rounded text-center",children:t.jsxs(d,{type:"danger",children:["ចំនួនទឹកប្រាក់សរុបត្រូវតែស្មើនឹងតម្លៃដីសរុប ($",parseFloat(o.total_land_price).toLocaleString(),")"]})}),t.jsxs("div",{className:"flex justify-between mt-6",children:[t.jsx(p,{href:route("sale-contracts.select-lands",{id:o.id}),children:"ត្រឡប់"}),t.jsx(p,{type:"primary",onClick:E,loading:v,disabled:Math.abs(l-parseFloat(o.total_land_price))>.01||w,children:"បង្កើតកិច្ចសន្យា"})]})]})]})]})}export{Te as default};
