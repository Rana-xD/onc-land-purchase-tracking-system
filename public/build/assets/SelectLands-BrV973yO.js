import{r as p,j as e,Q as D,B as v,s as j,a as L}from"./app-C0Remzwy.js";import{n as f}from"./numberUtils-DuaFS_6b.js";import{A as O,b as A}from"./AdminLayout-6aB_fSHs.js";import{C as b}from"./index-Cfi4PyFn.js";import{S as K}from"./index-D8QTW78o.js";import{T as M}from"./index-_bYnS0vO.js";import{B as Q}from"./index-N7wpmPjk.js";import{I as G}from"./index-BgpcnuvQ.js";import{R as Z}from"./SearchOutlined-Dji_xwpY.js";import{F as q}from"./Table-f_13r9sB.js";import{T as w}from"./index-BJSYyYck.js";import{D as H}from"./index-C-lGEDt7.js";import{R as J}from"./UserOutlined-9GEWtyEU.js";import{R as U}from"./EnvironmentOutlined-Dg-c_VSb.js";import{R as N}from"./DollarOutlined-DplF-jS5.js";import{R as V}from"./FileOutlined-Db19IYhn.js";import"./index-DQID86bo.js";import"./index-BkeYX-_W.js";import"./EllipsisOutlined-BvAucnIs.js";import"./PurePanel-LERcE_NN.js";import"./index-BC2OOC4T.js";import"./InboxOutlined-C_72B7nY.js";import"./useVariants-WSvFAMWE.js";import"./CheckOutlined-CBgC1XT7.js";import"./progress-DpSHyWCv.js";import"./EditOutlined-Kmrbx6Vn.js";import"./getAllowClear-Ch9so_13.js";import"./Input-Db4JReOf.js";import"./EyeOutlined-6voGcLSB.js";import"./addEventListener-CtdSgQvb.js";import"./index-O-VEiTMD.js";import"./useIcons-DwOnc_7J.js";import"./DownOutlined-TtH06v5g.js";import"./index-Cs8PXHGs.js";import"./Pagination-Bju1z6pp.js";import"./index-wspRjdfS.js";import"./FolderOutlined-E4df3Q5l.js";const{Title:S,Text:I}=M;function Fe({document:l,lands:_,selectedLands:m,editMode:R}){const[T,g]=p.useState(!1),[a,h]=p.useState([]),[i,d]=p.useState({}),[$,y]=p.useState(0),[u,z]=p.useState("");p.useEffect(()=>{if(m&&Object.keys(m).length>0){console.log("Initializing selectedLands:",m);const t=Object.keys(m).map(r=>parseInt(r));h(t);const s={};let o=0;t.forEach(r=>{const n=m[r];n&&(s[r]={price_per_m2:n.price_per_m2,total_price:parseFloat(n.total_price)||0},o+=parseFloat(n.total_price)||0)}),d(s),y(o)}},[m]),p.useEffect(()=>{let t=0;Object.values(i).forEach(s=>{s.total_price&&(t+=parseFloat(s.total_price))}),y(t)},[i]);const P=(t,s)=>{const o=_.find(n=>n.id===t);if(!o)return;const r=s*parseFloat(o.size);d({...i,[t]:{price_per_m2:s,total_price:r}})},C=(t,s)=>{d({...i,[t]:{price_per_m2:null,total_price:s}})},k=_.filter(t=>{if(!u)return!0;const s=f(u),o=f(t.plot_number),r=f(t.location),n=f(t.size);return o.includes(s)||r.includes(s)||n.includes(s)}),F=[{title:"ជ្រើសរើស",dataIndex:"id",key:"selection",render:t=>e.jsx("input",{type:"checkbox",checked:a.includes(t),onChange:s=>{if(s.target.checked)h([...a,t]),i[t]||d({...i,[t]:{price_per_m2:null,total_price:0}});else{h(a.filter(r=>r!==t));const o={...i};delete o[t],d(o)}}})},{title:"លេខក្បាលដី",dataIndex:"plot_number",key:"plot_number"},{title:"ទំហំ",dataIndex:"size",key:"size",render:t=>`${t} m²`},{title:"ទីតាំង",dataIndex:"location",key:"location"}],E=async()=>{if(a.length===0){j.error("សូមជ្រើសរើសយ៉ាងហោចណាស់មួយ");return}if(a.some(s=>!i[s]||!i[s].total_price)){j.error("សូមបញ្ចូលតម្លៃសម្រាប់ដីទាំងអស់");return}g(!0);try{const s=a.map(r=>({land_id:r,price_per_m2:i[r].price_per_m2,total_price:i[r].total_price})),o=l.document_type==="deposit_contract"?"deposit-contracts":"sale-contracts";await L.post(`/api/${o}/${l.id}/select-lands`,{lands:s}),l.document_type==="deposit_contract"?window.location.href=route("deposit-contracts.deposit-config",{id:l.id}):window.location.href=route("sale-contracts.payment-steps",{id:l.id})}catch(s){console.error("Error selecting lands:",s),j.error("មានបញ្ហាក្នុងការជ្រើសរើសដី")}finally{g(!1)}},B=2,x=[{title:"ជ្រើសរើសអ្នកទិញ",icon:e.jsx(J,{})},{title:"ជ្រើសរើសអ្នកលក់",icon:e.jsx(A,{})},{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ",icon:e.jsx(U,{})}];return l.document_type==="deposit_contract"?x.push({title:"កំណត់ការកក់ប្រាក់",icon:e.jsx(N,{})}):x.push({title:"ដំណាក់កាលបង់ប្រាក់",icon:e.jsx(N,{})}),x.push({title:"បង្កើតកិច្ចសន្យា",icon:e.jsx(V,{})}),e.jsxs(O,{children:[e.jsx(D,{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ"}),e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsx(b,{className:"mb-6",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsx(K,{current:B,items:x,responsive:!0,className:"site-navigation-steps",size:"small"})})}),e.jsxs(b,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(S,{level:3,children:R?"កែសម្រួលដី និងកំណត់តម្លៃ":"ជ្រើសរើសដី និងកំណត់តម្លៃ"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(I,{className:"mr-2",children:"បានជ្រើសរើស"}),e.jsx(Q,{count:a.length,showZero:!0,style:{marginTop:"0"}})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(G,{placeholder:"ស្វែងរកតាមលេខក្បាលដី ទំហំ ឬទីតាំង",prefix:e.jsx(Z,{}),value:u,onChange:t=>z(t.target.value),style:{width:"100%"}})}),e.jsx(q,{rowKey:"id",columns:F,dataSource:k,pagination:{pageSize:10},rowClassName:t=>a.includes(t.id)?"bg-blue-50":"",expandable:{expandedRowRender:t=>{var s,o,r,n;return a.includes(t.id)?e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:"តម្លៃក្នុង 1m² (Price per m²):"}),e.jsx("div",{children:e.jsx(w,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:(s=i[t.id])==null?void 0:s.price_per_m2,onChange:c=>P(t.id,c),placeholder:"បញ្ចូលតម្លៃក្នុង 1m²",formatter:c=>c?`${c}`:""})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:"ឬ តម្លៃសរុប (Total Price):"}),e.jsx("div",{children:e.jsx(w,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:(o=i[t.id])==null?void 0:o.total_price,onChange:c=>C(t.id,c),placeholder:"បញ្ចូលតម្លៃសរុប",formatter:c=>c?`${c}`:""})})]})]}),((r=i[t.id])==null?void 0:r.total_price)>0&&e.jsx("div",{className:"mt-4 text-right",children:e.jsxs(I,{strong:!0,children:["តម្លៃសរុប: $",parseFloat((n=i[t.id])==null?void 0:n.total_price).toLocaleString()]})})]}):null},expandedRowKeys:a}}),e.jsx(H,{}),e.jsx("div",{className:"text-right mb-6",children:e.jsxs(S,{level:4,children:["តម្លៃដីសរុប: $",$.toLocaleString()]})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(v,{href:route(l.document_type==="deposit_contract"?"deposit-contracts.select-sellers":"sale-contracts.select-sellers",{id:l.id}),children:"ត្រឡប់"}),e.jsx(v,{type:"primary",onClick:E,loading:T,disabled:a.length===0,children:"បន្ត"})]})]})]})]})}export{Fe as default};
