import{j as e,Q as P,r as t,B as g,a as x,s as n}from"./app-C0Remzwy.js";import{A as E}from"./AdminLayout-6aB_fSHs.js";import{F as c}from"./index-BkP9y4f7.js";import{C as N}from"./index-Cfi4PyFn.js";import{R as ie,C as f}from"./row-smlQ8Pun.js";import{I as m}from"./index-BgpcnuvQ.js";import{S as p}from"./index-O-VEiTMD.js";import{R as ce}from"./ReloadOutlined-DnRph-xO.js";import{R as de}from"./UserAddOutlined-BOBelBDx.js";import{S as me}from"./index-wspRjdfS.js";import{F as pe}from"./Table-f_13r9sB.js";import{M as $}from"./index-D4i_TDIH.js";import{T as ue}from"./index-DPCB1Teb.js";import{B as z}from"./index-N7wpmPjk.js";import{S as xe}from"./index-BC2OOC4T.js";import{T as _}from"./index-BkeYX-_W.js";import{R as he}from"./EditOutlined-Kmrbx6Vn.js";import{R as ge}from"./StopOutlined-Btq8k_oi.js";import{R as fe}from"./CheckCircleOutlined-CWvD94-R.js";import{P as je}from"./index-DRI1sxTS.js";import{R as ve}from"./DeleteOutlined-r_CR62zJ.js";import"./UserOutlined-9GEWtyEU.js";import"./index-DQID86bo.js";import"./EllipsisOutlined-BvAucnIs.js";import"./PurePanel-LERcE_NN.js";import"./InboxOutlined-C_72B7nY.js";import"./useVariants-WSvFAMWE.js";import"./getAllowClear-Ch9so_13.js";import"./Input-Db4JReOf.js";import"./EyeOutlined-6voGcLSB.js";import"./SearchOutlined-Dji_xwpY.js";import"./useIcons-DwOnc_7J.js";import"./CheckOutlined-CBgC1XT7.js";import"./DownOutlined-TtH06v5g.js";import"./addEventListener-CtdSgQvb.js";import"./index-Cs8PXHGs.js";import"./Pagination-Bju1z6pp.js";import"./FileOutlined-Db19IYhn.js";import"./FolderOutlined-E4df3Q5l.js";function ds({auth:l}){var k,T,F,O;if(!(((T=(k=l==null?void 0:l.user)==null?void 0:k.assigned_role)==null?void 0:T.name)==="admin"||((O=(F=l==null?void 0:l.user)==null?void 0:F.assigned_role)==null?void 0:O.name)==="manager"))return e.jsxs(E,{children:[e.jsx(P,{title:"មិនមានសិទ្ធិ"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white overflow-hidden shadow-sm sm:rounded-lg",children:e.jsxs("div",{className:"p-6 text-gray-900",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4 text-red-600",children:"មិនមានសិទ្ធិ"}),e.jsx("p",{children:"អ្នកមិនមានសិទ្ធិចូលប្រើប្រាស់ទំព័រនេះទេ។"})]})})})})]});const[A,U]=t.useState([]),[q,b]=t.useState(!0),[w,B]=t.useState({current:1,pageSize:10,total:0}),[Se,ye]=t.useState(""),[_e,be]=t.useState("");t.useRef(null);const[L,S]=t.useState(!1),[Q,y]=t.useState(!1),[j]=c.useForm(),[i,D]=t.useState(null),[h,C]=t.useState(null),[o,R]=t.useState({search:"",role:"all",status:"all"}),[K,V]=t.useState([]),d=async(s={})=>{b(!0);try{const{page:a=1,search:r=o.search,role:u=o.role,status:M=o.status}=s,v=await x.get("/api/users",{params:{page:a,search:r,role:u,status:M}});U(v.data.data),B({current:v.data.current_page,pageSize:v.data.per_page,total:v.data.total}),R({search:r,role:u,status:M})}catch(a){console.error("Error fetching users:",a),n.error("មានបញ្ហាក្នុងការទាញយកទិន្នន័យអ្នកប្រើប្រាស់")}finally{b(!1)}},Z=async()=>{try{const s=await x.get("/api/roles/for-select");V(s.data.data||[])}catch(s){console.error("Error fetching roles:",s)}};t.useEffect(()=>{d(),Z()},[]);const G=s=>{d({page:s.current,...o})},H=s=>{d({search:s,page:1})},J=s=>{d({role:s,page:1})},W=s=>{d({status:s,page:1})},X=()=>{d({search:"",role:"all",status:"all",page:1})},I=(s=null)=>{D(s),S(!0),s?j.setFieldsValue({name:s.name,username:s.username,role_id:s.role_id,is_active:s.is_active}):j.resetFields()},Y=s=>{C(s),y(!0)},ee=async()=>{try{const s=await j.validateFields();i?(await x.put(`/api/users/${i.id}`,s),n.success("អ្នកប្រើប្រាស់ត្រូវបានកែប្រែដោយជោគជ័យ")):(await x.post("/api/users",s),n.success("អ្នកប្រើប្រាស់ត្រូវបានបង្កើតដោយជោគជ័យ")),S(!1),d(o)}catch(s){if(s.response&&s.response.data&&s.response.data.message)n.error(s.response.data.message);else if(s.response&&s.response.data&&s.response.data.errors){const a=s.response.data.errors;Object.values(a).flat().forEach(u=>n.error(u))}else n.error("មានបញ្ហាក្នុងការរក្សាទុកទិន្នន័យ")}},se=()=>{S(!1)},ae=()=>{y(!1),C(null)},re=async()=>{try{await x.post(`/api/users/${h.id}/toggle-status`),n.success("ស្ថានភាពអ្នកប្រើប្រាស់ត្រូវបានផ្លាស់ប្តូរដោយជោគជ័យ"),y(!1),d(o)}catch(s){s.response&&s.response.data&&s.response.data.message?n.error(s.response.data.message):n.error("មានបញ្ហាក្នុងការផ្លាស់ប្តូរស្ថានភាព")}},te=async s=>{try{await x.delete(`/api/users/${s}`),n.success("អ្នកប្រើប្រាស់ត្រូវបានលុបដោយជោគជ័យ"),d(o)}catch(a){a.response&&a.response.data&&a.response.data.message?n.error(a.response.data.message):n.error("មានបញ្ហាក្នុងការលុបអ្នកប្រើប្រាស់")}},le=s=>{switch(s){case"administrator":return"red";case"manager":return"blue";case"staff":return"green";default:return"default"}},ne=s=>{switch(s){case"administrator":return"អេតមីន";case"manager":return"អ្នកគ្រប់គ្រង";case"staff":return"បុគ្គលិក";default:return s}},oe=[{title:"ល.រ",key:"index",width:60,render:(s,a,r)=>(w.current-1)*w.pageSize+r+1},{title:"ឈ្មោះ",dataIndex:"name",key:"name",sorter:(s,a)=>s.name.localeCompare(a.name)},{title:"ឈ្មោះគណនី",dataIndex:"username",key:"username"},{title:"តួនាទី",dataIndex:"role",key:"role",render:(s,a)=>{const r=a.assigned_role?a.assigned_role.display_name:ne(s),u=a.assigned_role?"blue":le(s);return e.jsx(ue,{color:u,children:r})}},{title:"ស្ថានភាព",dataIndex:"is_active",key:"is_active",render:s=>s?e.jsx(z,{status:"success",text:"សកម្ម"}):e.jsx(z,{status:"error",text:"អសកម្ម"})},{title:"សកម្មភាព",key:"action",render:(s,a)=>{var r;return e.jsxs(xe,{size:"small",children:[e.jsx(_,{title:"កែប្រែ",children:e.jsx(g,{type:"primary",icon:e.jsx(he,{}),size:"small",onClick:()=>I(a),disabled:l.user.id===a.id&&!((r=l.user.assigned_role)!=null&&r.name)==="administrator"})}),e.jsx(_,{title:a.is_active?"បិទគណនី":"បើកគណនី",children:e.jsx(g,{type:a.is_active?"default":"primary",icon:a.is_active?e.jsx(ge,{}):e.jsx(fe,{}),size:"small",onClick:()=>Y(a),danger:a.is_active,disabled:l.user.id===a.id})}),l.user.id!==a.id&&e.jsx(_,{title:"លុប",children:e.jsx(je,{title:"តើអ្នកពិតជាចង់លុបអ្នកប្រើប្រាស់នេះមែនទេ?",description:"សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ",onConfirm:()=>te(a.id),okText:"បាទ/ចាស",cancelText:"ទេ",children:e.jsx(g,{danger:!0,icon:e.jsx(ve,{}),size:"small"})})})]})}}];return e.jsxs(E,{title:"គ្រប់គ្រងអ្នកប្រើប្រាស់",children:[e.jsx(P,{title:"គ្រប់គ្រងអ្នកប្រើប្រាស់"}),e.jsx(N,{className:"mb-4",children:e.jsxs(ie,{gutter:16,align:"middle",children:[e.jsx(f,{xs:24,sm:8,md:6,lg:6,xl:5,children:e.jsx(m.Search,{placeholder:"ស្វែងរកតាមឈ្មោះ ឬឈ្មោះគណនី",allowClear:!0,enterButton:!0,value:o.search,onChange:s=>R({...o,search:s.target.value}),onSearch:H})}),e.jsx(f,{xs:24,sm:8,md:5,lg:4,xl:3,children:e.jsx(p,{placeholder:"តួនាទី",style:{width:"100%"},value:o.role,onChange:J,options:[{value:"all",label:"តួនាទីទាំងអស់"},{value:"administrator",label:"អ្នកគ្រប់គ្រងប្រព័ន្ធ"},{value:"manager",label:"អ្នកគ្រប់គ្រង"},{value:"staff",label:"បុគ្គលិក"}]})}),e.jsx(f,{xs:24,sm:8,md:5,lg:4,xl:3,children:e.jsx(p,{placeholder:"ស្ថានភាព",style:{width:"100%"},value:o.status,onChange:W,options:[{value:"all",label:"ស្ថានភាពទាំងអស់"},{value:"active",label:"សកម្ម"},{value:"inactive",label:"អសកម្ម"}]})}),e.jsx(f,{xs:24,sm:8,md:4,lg:3,xl:3,children:e.jsx(g,{icon:e.jsx(ce,{}),onClick:X,children:"កំណត់ឡើងវិញ"})}),e.jsx(f,{xs:24,sm:16,md:4,lg:7,xl:10,className:"text-right",children:e.jsx(g,{type:"primary",icon:e.jsx(de,{}),onClick:()=>I(),children:"បង្កើតអ្នកប្រើប្រាស់ថ្មី"})})]})}),e.jsx(N,{children:e.jsx(me,{spinning:q,children:e.jsx(pe,{columns:oe,dataSource:A,rowKey:"id",pagination:w,onChange:G,scroll:{x:"max-content"}})})}),e.jsx($,{title:i?"កែប្រែអ្នកប្រើប្រាស់":"បង្កើតអ្នកប្រើប្រាស់ថ្មី",open:L,onOk:ee,onCancel:se,okText:i?"កែប្រែ":"បង្កើត",cancelText:"បោះបង់",maskClosable:!1,children:e.jsxs(c,{form:j,layout:"vertical",name:"userForm",children:[e.jsx(c.Item,{name:"name",label:"ឈ្មោះ",rules:[{required:!0,message:"សូមបញ្ចូលឈ្មោះ!"}],children:e.jsx(m,{})}),e.jsx(c.Item,{name:"username",label:"ឈ្មោះគណនី",rules:[{required:!0,message:"សូមបញ្ចូលឈ្មោះគណនី!"},{min:3,message:"ឈ្មោះគណនីត្រូវមានយ៉ាងតិច ៣ តួអក្សរ!"},{pattern:/^[a-zA-Z0-9_-]+$/,message:"ឈ្មោះគណនីអាចមានតែអក្សរ លេខ និងសញ្ញា _ ឬ - ប៉ុណ្ណោះ!"}],children:e.jsx(m,{})}),!i&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"password",label:"ពាក្យសម្ងាត់",rules:[{required:!0,message:"សូមបញ្ចូលពាក្យសម្ងាត់!"}],children:e.jsx(m.Password,{})}),e.jsx(c.Item,{name:"password_confirmation",label:"បញ្ជាក់ពាក្យសម្ងាត់",dependencies:["password"],rules:[{required:!0,message:"សូមបញ្ជាក់ពាក្យសម្ងាត់!"},({getFieldValue:s})=>({validator(a,r){return!r||s("password")===r?Promise.resolve():Promise.reject(new Error("ពាក្យសម្ងាត់ទាំងពីរមិនត្រូវគ្នា!"))}})],children:e.jsx(m.Password,{})})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"password",label:"ពាក្យសម្ងាត់ថ្មី (ទុកទទេបើមិនចង់ផ្លាស់ប្តូរ)",rules:[{min:6,message:"ពាក្យសម្ងាត់ត្រូវមានយ៉ាងតិច ៦ តួអក្សរ!",validateTrigger:"onChange"}],children:e.jsx(m.Password,{})}),e.jsx(c.Item,{name:"password_confirmation",label:"បញ្ជាក់ពាក្យសម្ងាត់ថ្មី",dependencies:["password"],rules:[({getFieldValue:s})=>({validator(a,r){return!s("password")||!r||s("password")===r?Promise.resolve():Promise.reject(new Error("ពាក្យសម្ងាត់ទាំងពីរមិនត្រូវគ្នា!"))}})],children:e.jsx(m.Password,{})})]}),e.jsx(c.Item,{name:"role_id",label:"តួនាទី",rules:[{required:!0,message:"សូមជ្រើសរើសតួនាទី!"}],children:e.jsx(p,{placeholder:"ជ្រើសរើសតួនាទី",disabled:i&&l.user.id===i.id,showSearch:!0,filterOption:(s,a)=>a.children.toLowerCase().indexOf(s.toLowerCase())>=0,children:K.map(s=>e.jsx(p.Option,{value:s.id,children:s.display_name},s.id))})}),i&&e.jsx(c.Item,{name:"is_active",label:"ស្ថានភាព",valuePropName:"checked",initialValue:!0,children:e.jsxs(p,{disabled:l.user.id===i.id,children:[e.jsx(p.Option,{value:!0,children:"សកម្ម"}),e.jsx(p.Option,{value:!1,children:"អសកម្ម"})]})})]})}),e.jsx($,{title:"បញ្ជាក់ការផ្លាស់ប្តូរស្ថានភាព",open:Q,onOk:re,onCancel:ae,okText:"បញ្ជាក់",cancelText:"បោះបង់",children:h&&e.jsxs("p",{children:["តើអ្នកពិតជាចង់",h.is_active?"បិទ":"បើក","គណនីរបស់",e.jsxs("strong",{children:[" ",h.name]})," (",h.username,") មែនទេ?"]})})]})}export{ds as default};
