import{r as p,j as e,Q as L,d as B}from"./app-D0OhDuOP.js";import{n as f}from"./numberUtils-DuaFS_6b.js";import{A as D,B as A,b as K}from"./AdminLayout-DfyZC7U7.js";import{C as v}from"./index-BXZQm44E.js";import{S as M}from"./index-DeYg2bFH.js";import{T as O}from"./index-DUD5X347.js";import{I as Q}from"./index-DyIYvMCA.js";import{R as G}from"./SearchOutlined-DdbS1Qlk.js";import{F as Z}from"./Table-CJMywyvl.js";import{T as b}from"./index-Dx6sVVHZ.js";import{D as q}from"./index-BoUcoXbW.js";import{B as w}from"./index-XQ9uBlxv.js";import{s as j}from"./index-VXrvBi_7.js";import{R as H}from"./UserOutlined-Bw1Yg3TV.js";import{R as J}from"./EnvironmentOutlined-C6fAnWDm.js";import{R as N}from"./DollarOutlined-BgkhO_OZ.js";import{R as U}from"./FileOutlined-CmtzEeI9.js";import"./index-BKPGZTnh.js";import"./EllipsisOutlined-BcUT9_x5.js";import"./PurePanel-BrlMViLC.js";import"./index-CpY42lHj.js";import"./Skeleton-BB1PfEPR.js";import"./CloseOutlined-CSg-7HVH.js";import"./useVariants-VmmnPvRy.js";import"./CheckOutlined-C-W3vkf9.js";import"./progress-CZwQN1Wi.js";import"./ExclamationCircleFilled-BuCwC-hN.js";import"./EditOutlined-BQAB7wjt.js";import"./getAllowClear-7r21EHJH.js";import"./Input-DIi4XD1o.js";import"./pickAttrs-BMtZpb9Y.js";import"./EyeOutlined-Bk9sN1n5.js";import"./addEventListener-Dvq9iQDE.js";import"./index-BXlDNFm_.js";import"./useIcons-De8HtjeC.js";import"./DownOutlined-BKT6hG3e.js";import"./index-CxyNWzZ_.js";import"./useBubbleLock-Dp5g0NxF.js";import"./index-HowiUfuo.js";import"./Pagination-C28t5-1k.js";import"./index-Bjcdw0HM.js";import"./extendsObject-78o_rR5W.js";import"./FolderOutlined-CsvjmU0T.js";import"./InfoCircleFilled-Csbq1HVY.js";const{Title:S,Text:R}=O;function Ke({document:l,lands:_,selectedLands:d}){const[I,g]=p.useState(!1),[a,h]=p.useState([]),[s,m]=p.useState({}),[T,y]=p.useState(0),[u,$]=p.useState("");p.useEffect(()=>{if(d){const t=Object.keys(d).map(i=>parseInt(i));h(t);const r={};let o=0;t.forEach(i=>{const n=d[i];r[i]={price_per_m2:n.price_per_m2,total_price:n.total_price},o+=parseFloat(n.total_price)}),m(r),y(o)}},[d]),p.useEffect(()=>{let t=0;Object.values(s).forEach(r=>{r.total_price&&(t+=parseFloat(r.total_price))}),y(t)},[s]);const P=(t,r)=>{const o=_.find(n=>n.id===t);if(!o)return;const i=r*parseFloat(o.size);m({...s,[t]:{price_per_m2:r,total_price:i}})},z=(t,r)=>{m({...s,[t]:{price_per_m2:null,total_price:r}})},C=_.filter(t=>{if(!u)return!0;const r=f(u),o=f(t.plot_number),i=f(t.location),n=f(t.size);return o.includes(r)||i.includes(r)||n.includes(r)}),k=[{title:"ជ្រើសរើស",dataIndex:"id",key:"selection",render:t=>e.jsx("input",{type:"checkbox",checked:a.includes(t),onChange:r=>{if(r.target.checked)h([...a,t]),s[t]||m({...s,[t]:{price_per_m2:null,total_price:0}});else{h(a.filter(i=>i!==t));const o={...s};delete o[t],m(o)}}})},{title:"លេខដី",dataIndex:"plot_number",key:"plot_number"},{title:"ទំហំ",dataIndex:"size",key:"size",render:t=>`${t} m²`},{title:"ទីតាំង",dataIndex:"location",key:"location"}],E=async()=>{if(a.length===0){j.error("សូមជ្រើសរើសយ៉ាងហោចណាស់មួយ");return}if(a.some(r=>!s[r]||!s[r].total_price)){j.error("សូមបញ្ចូលតម្លៃសម្រាប់ដីទាំងអស់");return}g(!0);try{const r=a.map(i=>({land_id:i,price_per_m2:s[i].price_per_m2,total_price:s[i].total_price})),o=l.document_type==="deposit_contract"?"deposit-contracts":"sale-contracts";await B.post(`/api/${o}/${l.id}/select-lands`,{lands:r}),l.document_type==="deposit_contract"?window.location.href=route("deposit-contracts.deposit-config",{id:l.id}):window.location.href=route("sale-contracts.payment-steps",{id:l.id})}catch(r){console.error("Error selecting lands:",r),j.error("មានបញ្ហាក្នុងការជ្រើសរើសដី")}finally{g(!1)}},F=2,x=[{title:"ជ្រើសរើសអ្នកទិញ",icon:e.jsx(H,{})},{title:"ជ្រើសរើសអ្នកលក់",icon:e.jsx(K,{})},{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ",icon:e.jsx(J,{})}];return l.document_type==="deposit_contract"?x.push({title:"កំណត់ការកក់ប្រាក់",icon:e.jsx(N,{})}):x.push({title:"ដំណាក់កាលបង់ប្រាក់",icon:e.jsx(N,{})}),x.push({title:"បង្កើតឯកសារ",icon:e.jsx(U,{})}),e.jsxs(D,{children:[e.jsx(L,{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ"}),e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsx(v,{className:"mb-6",children:e.jsx("div",{className:"overflow-x-auto",children:e.jsx(M,{current:F,items:x,responsive:!0,className:"site-navigation-steps",size:"small"})})}),e.jsxs(v,{children:[e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(S,{level:3,children:"ជ្រើសរើសដី និងកំណត់តម្លៃ"}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(R,{className:"mr-2",children:"បានជ្រើសរើស"}),e.jsx(A,{count:a.length,showZero:!0,style:{marginTop:"0"}})]})]}),e.jsx("div",{className:"mb-4",children:e.jsx(Q,{placeholder:"ស្វែងរកតាមលេខដី ទំហំ ឬទីតាំង",prefix:e.jsx(G,{}),value:u,onChange:t=>$(t.target.value),style:{width:"100%"}})}),e.jsx(Z,{rowKey:"id",columns:k,dataSource:C,pagination:{pageSize:10},rowClassName:t=>a.includes(t.id)?"bg-blue-50":"",expandable:{expandedRowRender:t=>{var r,o,i,n;return a.includes(t.id)?e.jsxs("div",{className:"p-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:"តម្លៃក្នុង 1m² (Price per m²):"}),e.jsx("div",{children:e.jsx(b,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:(r=s[t.id])==null?void 0:r.price_per_m2,onChange:c=>P(t.id,c),placeholder:"បញ្ចូលតម្លៃក្នុង 1m²",formatter:c=>c?`${c}`:""})})]}),e.jsxs("div",{children:[e.jsx("div",{className:"mb-2",children:"ឬ តម្លៃសរុប (Total Price):"}),e.jsx("div",{children:e.jsx(b,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:(o=s[t.id])==null?void 0:o.total_price,onChange:c=>z(t.id,c),placeholder:"បញ្ចូលតម្លៃសរុប",formatter:c=>c?`${c}`:""})})]})]}),((i=s[t.id])==null?void 0:i.total_price)>0&&e.jsx("div",{className:"mt-4 text-right",children:e.jsxs(R,{strong:!0,children:["តម្លៃសរុប: $",parseFloat((n=s[t.id])==null?void 0:n.total_price).toLocaleString()]})})]}):null},expandedRowKeys:a}}),e.jsx(q,{}),e.jsx("div",{className:"text-right mb-6",children:e.jsxs(S,{level:4,children:["តម្លៃដីសរុប: $",T.toLocaleString()]})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(w,{href:route(l.document_type==="deposit_contract"?"deposit-contracts.select-sellers":"sale-contracts.select-sellers",{id:l.id}),children:"ត្រឡប់"}),e.jsx(w,{type:"primary",onClick:E,loading:I,disabled:a.length===0,children:"បន្ត"})]})]})]})]})}export{Ke as default};
