import{a0 as T,r as l,j as e,Q as Y,B as p,s as c,f as h}from"./app-BGhGKeDm.js";import{A as k,b as L}from"./AdminLayout-BXXLLj0W.js";import{d as P}from"./dayjs.min-DaffgfEd.js";import{F as m}from"./index-DyTQAcgu.js";import{C as x,R as A}from"./index-qpGzGUeV.js";import{S as q}from"./index-BYTVIrqD.js";import{T as z}from"./index-B6xJCuJM.js";import{D as j}from"./index-euUqC7cP.js";import{R as B}from"./DeleteOutlined-B1rwMVkI.js";import{I as Q}from"./index-BEgchehC.js";import{T as G}from"./index-drRNaaZ5.js";import{D as H}from"./index-DMXyt4ie.js";import{R as J}from"./UserOutlined-DWxAHtSB.js";import{R as K}from"./EnvironmentOutlined-BQvBhiww.js";import{R as O}from"./DollarOutlined-D6LURsAa.js";import{R as U}from"./FileOutlined-fgq6oFF6.js";import"./index-B1PYG0UW.js";import"./index-BlrWONL6.js";import"./EllipsisOutlined-BvZqw2BO.js";import"./PurePanel-BI8-qUZa.js";import"./index-DyBnwjTx.js";import"./row-Ec-3Wmhs.js";import"./useVariants-CfoUH3-7.js";import"./CheckOutlined-CzLtFOuT.js";import"./progress-BgNPOd5E.js";import"./EditOutlined-Cmt36UP2.js";import"./getAllowClear-Um0uvhCc.js";import"./Input-DQj-54rS.js";import"./EyeOutlined-DxjRXQL_.js";import"./SearchOutlined-BcwQGR4p.js";import"./DownOutlined-B_G3bdVf.js";import"./CalendarOutlined-DbFMZUR1.js";import"./ClockCircleOutlined-BC1I0oaT.js";import"./useIcons-7uZy_G_6.js";const{Title:_,Text:d}=z;function Fe({document:o,paymentSteps:y}){const{csrf_token:u}=T().props,[g,f]=l.useState(!1),[b]=m.useForm(),[a,i]=l.useState(y||[{step_number:1,amount:"",due_date:null,payment_time_description:""}]),[n,S]=l.useState(0),[v,$]=l.useState(!0);l.useEffect(()=>{let r=0,s=!1;a.forEach(t=>{t.amount&&(r+=parseFloat(t.amount)),(!t.amount||!t.due_date||!t.payment_time_description)&&(s=!0)}),S(r),$(s)},[a]);const D=()=>{const r=a.length+1;i([...a,{step_number:r,amount:"",due_date:null,payment_time_description:""}])},N=r=>{if(a.length<=1){c.error("យ៉ាងហោចណាស់ត្រូវមានដំណាក់កាលបង់ប្រាក់មួយ");return}const s=[...a];s.splice(r,1),s.forEach((t,E)=>{t.step_number=E+1}),i(s)},w=(r,s)=>{const t=[...a];t[r].amount=s,i(t)},I=(r,s)=>{const t=[...a];t[r].due_date=s?s.format("YYYY-MM-DD"):null,i(t)},R=(r,s)=>{const t=[...a];t[r].payment_time_description=s,i(t)},F=async()=>{if(a.some(t=>!t.amount||!t.due_date||!t.payment_time_description)){c.error("សូមបញ្ចូលចំនួនទឹកប្រាក់, កាលបរិច្ឆេទ និងពេលវេលាបង់ប្រាក់សម្រាប់ដំណាក់កាលទាំងអស់");return}const s=parseFloat(o.total_land_price);if(Math.abs(n-s)>.01){c.error(`ចំនួនទឹកប្រាក់សរុបត្រូវតែស្មើនឹងតម្លៃដីសរុប ($${s.toLocaleString()})`);return}f(!0);try{const t="sale-contracts";await h.post(`/api/${t}/${o.id}/payment-steps`,{payment_steps:a,_token:u}),await h.post(`/api/${t}/${o.id}/generate`,{_token:u}),window.location.href=route("sale-contracts.success",{id:o.id})}catch(t){console.error("បញ្ហាក្នុងការបង្កើតឯកសារ:",t),t.response&&t.response.data&&t.response.data.error?c.error(t.response.data.error):c.error("មានបញ្ហាក្នុងការបង្កើតឯកសារ")}finally{f(!1)}},M=3,C=[{title:"ជ្រើសរើសអ្នកទិញ",icon:e.jsx(J,{})},{title:"ជ្រើសរើសអ្នកលក់",icon:e.jsx(L,{})},{title:"ជ្រើសរើសដី និងកំណត់តម្លៃ",icon:e.jsx(K,{})},{title:"ដំណាក់កាលបង់ប្រាក់",icon:e.jsx(O,{})},{title:"បង្កើតឯកសារ",icon:e.jsx(U,{})}];return e.jsxs(k,{children:[e.jsx(Y,{title:"ដំណាក់កាលបង់ប្រាក់"}),e.jsxs("div",{className:"container mx-auto py-6",children:[e.jsx(x,{className:"mb-6",children:e.jsx(q,{current:M,items:C,responsive:!0,className:"site-navigation-steps",size:"small"})}),e.jsxs(x,{children:[e.jsx(_,{level:3,className:"mb-6",children:"ដំណាក់កាលបង់ប្រាក់"}),e.jsx("div",{className:"mb-6",children:e.jsxs(d,{strong:!0,children:["តម្លៃដីសរុប: $",parseFloat(o.total_land_price).toLocaleString()]})}),e.jsx(j,{}),e.jsxs(m,{form:b,layout:"vertical",children:[a.map((r,s)=>e.jsxs("div",{className:"mb-8 p-4 border rounded-md bg-gray-50",children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsxs(_,{level:5,children:["ដំណាក់កាលទី ",r.step_number]}),e.jsx(p,{danger:!0,icon:e.jsx(B,{}),onClick:()=>N(s),disabled:a.length<=1})]}),e.jsxs("div",{className:"grid grid-cols-1 gap-4",children:[e.jsx(m.Item,{label:"ពេលវេលាបង់ប្រាក់ (Payment Time Description)",required:!0,children:e.jsx(Q,{value:r.payment_time_description,onChange:t=>R(s,t.target.value),placeholder:"បញ្ចូលពេលវេលាបង់ប្រាក់"})}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsx(m.Item,{label:"ចំនួនទឹកប្រាក់ (Amount)",required:!0,children:e.jsx(G,{style:{width:"100%"},min:0,precision:2,prefix:"$",value:r.amount,onChange:t=>w(s,t),placeholder:"បញ្ចូលចំនួនទឹកប្រាក់"})}),e.jsx(m.Item,{label:"កាលបរិច្ឆេទត្រូវបង់ (Due Date)",required:!0,children:e.jsx(H,{style:{width:"100%"},value:r.due_date?P(r.due_date):null,onChange:t=>I(s,t),placeholder:"ជ្រើសរើសកាលបរិច្ឆេទ",format:"DD/MM/YYYY"})})]})]})]},s)),e.jsx("div",{className:"text-center mb-6",children:e.jsx(p,{type:"dashed",icon:e.jsx(A,{}),onClick:D,children:"បន្ថែមដំណាក់កាលបង់ប្រាក់"})})]}),e.jsx(j,{}),e.jsxs("div",{className:"flex justify-between items-center mb-6",children:[e.jsx(d,{strong:!0,children:"ចំនួនទឹកប្រាក់សរុប:"}),e.jsxs(d,{strong:!0,style:{fontSize:"1.2rem",color:Math.abs(n-parseFloat(o.total_land_price))>.01?"red":"green"},children:["$",n.toLocaleString()]})]}),Math.abs(n-parseFloat(o.total_land_price))>.01&&e.jsx("div",{className:"mb-6 p-2 bg-red-50 border border-red-200 rounded text-center",children:e.jsxs(d,{type:"danger",children:["ចំនួនទឹកប្រាក់សរុបត្រូវតែស្មើនឹងតម្លៃដីសរុប ($",parseFloat(o.total_land_price).toLocaleString(),")"]})}),e.jsxs("div",{className:"flex justify-between mt-6",children:[e.jsx(p,{href:route("sale-contracts.select-lands",{id:o.id}),children:"ត្រឡប់"}),e.jsx(p,{type:"primary",onClick:F,loading:g,disabled:Math.abs(n-parseFloat(o.total_land_price))>.01||v,children:"បង្កើតឯកសារ"})]})]})]})]})}export{Fe as default};
