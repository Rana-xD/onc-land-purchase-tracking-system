import{s as T,r as j,j as r,B,a as J}from"./app-zwF1qXmt.js";import{T as Z}from"./index-Bur7rjdX.js";import{C as I}from"./index-BViq9QJ5.js";import{T as F}from"./index-B73L-RiE.js";import{T as ee}from"./index-CyChZ65t.js";import{R as se}from"./EyeOutlined-DlB_godP.js";import{R as te}from"./CheckCircleOutlined-DSJjJs7V.js";import{M as H}from"./index-DNJxu2mi.js";import{R as re}from"./DeleteOutlined-CSBNabzb.js";import{R as ae}from"./FilePdfOutlined-BXGogZ6d.js";import{R as ne}from"./FileImageOutlined-FpPaQLNC.js";import{U as ie}from"./index-DvDWTSxT.js";import{S as oe}from"./index-lwJ32dcB.js";import{R as le}from"./UploadOutlined-ei3K2afn.js";const h={success:(c,n=3,i)=>{T.success({content:c,duration:n,onClose:i})},error:(c,n=3,i)=>{T.error({content:c,duration:n,onClose:i})},info:(c,n=3,i)=>{T.info({content:c,duration:n,onClose:i})},warning:(c,n=3,i)=>{T.warning({content:c,duration:n,onClose:i})},loading:(c,n=0,i)=>T.loading({content:c,duration:n,onClose:i})},{Title:pe,Text:ce}=Z,y={fileGridContainer:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px",marginBottom:"24px"},fileCard:{width:"100%",height:"100%",display:"flex",flexDirection:"column"},fileCardCover:{padding:"12px",textAlign:"center",height:"180px",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"},filePreviewImage:{maxHeight:"160px",maxWidth:"100%",objectFit:"contain"},fileIconContainer:{textAlign:"center"},fileIcon:{fontSize:"48px"},fileName:{marginTop:"8px",wordBreak:"break-word",overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},displayTag:{marginTop:"4px"}};function De({category:c,referenceId:n=null,initialFiles:i=[],onFilesChange:x,maxFiles:O=2,maxSize:N=10}){const[o,f]=j.useState([]),[z,C]=j.useState(!1),[V,$]=j.useState(!1),[U,S]=j.useState(""),[k,W]=j.useState("");j.useEffect(()=>{if(i&&i.length>0&&o.length===0){const s=i.map(t=>({uid:t.id,name:t.file_name,status:"done",url:`/storage/${t.file_path}`,response:{id:t.id,path:t.file_path},isDisplay:t.is_display,isExisting:!0}));f(s)}},[i]);const M=async s=>{if(s.url){S(s.url),$(!0),W(s.name);return}if(s.originFileObj){const t=await A(s.originFileObj);S(t),$(!0),W(s.name||s.url.substring(s.url.lastIndexOf("/")+1))}},A=s=>new Promise((t,l)=>{const d=new FileReader;d.readAsDataURL(s),d.onload=()=>t(d.result),d.onerror=m=>l(m)}),q=async({file:s,onSuccess:t,onError:l})=>{if(!(s.type==="image/jpeg"||s.type==="image/png"||s.type==="application/pdf")){h.error("អ្នកអាចផ្ទុកឡើងបានតែកិច្ចសន្យាប្រភេទ JPG, PNG, ឬ PDF ប៉ុណ្ណោះ!"),l("File type error");return}if(!(s.size/1024/1024<N)){h.error(`អ្នកអាចផ្ទុកឡើងបានតែកិច្ចសន្យាទំហំតូចជាង ${N}MB ប៉ុណ្ណោះ!`),l("File size error");return}C(!0);try{const g=new FileReader;g.readAsDataURL(s),g.onload=()=>{const e=g.result,u={success:!0,file:{fileName:s.name,base64:e,mimeType:s.type,size:s.size}};t(u),C(!1)},h.success("កិច្ចសន្យាត្រូវបានផ្ទុកឡើងដោយជោគជ័យ")}catch(g){console.error("Error uploading file:",g),h.error("មានបញ្ហាក្នុងការផ្ទុកឡើងកិច្ចសន្យា"),l("Upload failed")}finally{C(!1)}},G=async({file:s,fileList:t})=>{console.log("FileUpload handleChange called",{file:s,fileList:t.length});let l=[...t];if(o.length===2&&t.length>2){const e=o.find(a=>a.isDisplay),u=o.find(a=>!a.isDisplay);e&&u?l=[e,t[t.length-1]]:l=[o[1],t[t.length-1]]}const m=(await Promise.all(l.map(async e=>{var u,a,p,P,w,v,R,D;if(e.base64)return e;if(e.status==="done"&&e.response&&((u=e.response.file)!=null&&u.base64))return{...e,url:e.response.file.base64,base64:e.response.file.base64,tempPath:((a=e.response.file)==null?void 0:a.tempPath)||null,fileName:e.name};if(e.originFileObj)try{const b=await A(e.originFileObj);return{...e,url:e.url||URL.createObjectURL(e.originFileObj),base64:b,fileName:e.name,tempPath:e.tempPath||((P=(p=e.response)==null?void 0:p.file)==null?void 0:P.tempPath)||((w=e.response)==null?void 0:w.path)}}catch(b){console.error("Error generating base64 for file:",b)}if(e.url&&!e.base64&&!e.url.startsWith("data:"))try{return{...e,base64:e.url,fileName:e.name,tempPath:e.tempPath||((R=(v=e.response)==null?void 0:v.file)==null?void 0:R.tempPath)||((D=e.response)==null?void 0:D.path)}}catch(b){console.error("Error handling existing file URL:",b)}return e}))).filter(e=>e.status!=="error");f(m);const g=m.map(e=>{var u;return console.log("Processing file for parent:",{name:e.name,tempPath:e.tempPath,status:e.status,hasBase64:!!e.base64,base64Length:e.base64?e.base64.substring(0,30)+"...":null}),{id:(u=e.response)==null?void 0:u.id,isExisting:e.isExisting||!1,tempPath:e.tempPath,url:e.url,base64:e.base64,fileName:e.name,mimeType:e.type||(e.originFileObj?e.originFileObj.type:"image/jpeg"),isDisplay:e.isDisplay||!1,response:e.response}});console.log("Files being sent to parent component:",g.map(e=>({...e,base64:e.base64?`${e.base64.substring(0,30)}...`:null}))),x&&typeof x=="function"&&x(g)},K=async s=>{if(s.isExisting&&n)try{const t=o.filter(l=>l.isDisplay);return t.length===1&&t[0].uid===s.uid?(h.error("មិនអាចលុបកិច្ចសន្យានេះបានទេ ព្រោះវាជាកិច្ចសន្យាតែមួយគត់ដែលបង្ហាញ។ សូមកំណត់កិច្ចសន្យាផ្សេងជាកិច្ចសន្យាបង្ហាញជាមុនសិន។"),!1):(await J.delete(`/api/${c}s/${n}/documents/${s.response.id}`),h.success("កិច្ចសន្យាត្រូវបានលុបដោយជោគជ័យ"),!0)}catch(t){return console.error("Error deleting file:",t),h.error("មានបញ្ហាក្នុងការលុបកិច្ចសន្យា"),!1}return!0},Q=async s=>{var g,e,u;console.log("Setting as display image:",s);const t=o.find(a=>a.uid===s.uid);console.log("Original file data:",t);const l=((e=(g=t==null?void 0:t.response)==null?void 0:g.file)==null?void 0:e.base64)||((u=t==null?void 0:t.url)!=null&&u.startsWith("data:")?t.url:null)||(t==null?void 0:t.base64);console.log("Base64 data found:",!!l);const d=o.map(a=>({...a,isDisplay:a.uid===s.uid}));f(d);const m=d.map(a=>{var P,w,v,R,D,b,_;const p={id:(P=a.response)==null?void 0:P.id,isExisting:a.isExisting||!1,tempPath:((v=(w=a.response)==null?void 0:w.file)==null?void 0:v.tempPath)||((R=a.response)==null?void 0:R.path),url:a.url,base64:((b=(D=a.response)==null?void 0:D.file)==null?void 0:b.base64)||((_=a.url)!=null&&_.startsWith("data:")?a.url:null)||a.base64,fileName:a.name,isDisplay:a.isDisplay,response:a.response};if(a.isDisplay&&(console.log("New file object for display:",p),!p.url||!p.url.startsWith("data:"))){if(p.base64)p.url=p.base64,console.log("Using base64 data as URL for display image");else if(p.tempPath)p.url=`/storage/${p.tempPath}`,console.log("Using tempPath as URL for display image");else if(a.originFileObj&&window.FileReader){const L=new FileReader;L.readAsDataURL(a.originFileObj),L.onload=()=>{const Y=m.map(E=>E.isDisplay?{...E,url:L.result,base64:L.result}:E);console.log("Created base64 URL for display image"),x&&typeof x=="function"&&x(Y)}}}return p});if(console.log("Files being sent to parent component (new):",m),x&&typeof x=="function"&&x(m),s.isExisting&&n)try{await J.put(`/api/${c}s/${n}/documents/${s.response.id}/set-display`),h.success("កិច្ចសន្យាត្រូវបានកំណត់ជាកិច្ចសន្យាបង្ហាញដោយជោគជ័យ")}catch(a){console.error("Error setting display document:",a),h.error("មានបញ្ហាក្នុងការកំណត់កិច្ចសន្យាបង្ហាញ"),f(o)}else h.success("កិច្ចសន្យាត្រូវបានកំណត់ជាកិច្ចសន្យាបង្ហាញដោយជោគជ័យ")},X=r.jsxs("div",{children:[r.jsx(le,{}),r.jsx("div",{style:{marginTop:8},children:"ផ្ទុកឡើង"})]});return r.jsxs("div",{className:"file-upload",children:[r.jsx(pe,{level:5,className:"khmer-heading mb-4",children:"កិច្ចសន្យា"}),r.jsxs(ce,{className:"khmer-text mb-4 block",children:["សូមផ្ទុកឡើងកិច្ចសន្យា (អតិបរមា ",O," កិច្ចសន្យា, ទំហំអតិបរមា ",N,"MB ក្នុងមួយកិច្ចសន្យា)"]}),o.length>0&&r.jsx("div",{style:y.fileGridContainer,children:o.map(s=>s.status==="error"?null:r.jsxs(I,{size:"small",className:`file-card ${s.isDisplay?"border-2 border-blue-500":""}`,style:y.fileCard,styles:{body:{padding:"8px",flex:"1 0 auto"}},cover:r.jsx("div",{style:y.fileCardCover,children:s.type&&s.type.includes("image")?r.jsx("img",{src:s.url||s.originFileObj&&URL.createObjectURL(s.originFileObj),alt:s.name,style:y.filePreviewImage}):r.jsxs("div",{style:y.fileIconContainer,children:[s.type&&s.type.includes("pdf")?r.jsx(ae,{style:{...y.fileIcon,color:"#ff4d4f"}}):r.jsx(ne,{style:{...y.fileIcon,color:"#1890ff"}}),r.jsx("div",{style:y.fileName,children:r.jsx(F,{title:s.name,children:s.name})})]})}),children:[r.jsxs("div",{style:{minHeight:"40px"},children:[r.jsx(F,{title:s.name,children:r.jsx("div",{style:y.fileName,children:s.name})}),s.isDisplay&&r.jsx(ee,{color:"blue",style:y.displayTag,children:"កិច្ចសន្យាបង្ហាញ"})]}),r.jsxs("div",{style:{marginTop:"12px",display:"flex",justifyContent:"space-between"},children:[r.jsx(B,{type:"text",icon:r.jsx(se,{}),onClick:()=>M(s),size:"small"}),r.jsx(F,{title:"កំណត់ជាបង្ហាញ",children:r.jsx(B,{type:s.isDisplay?"primary":"default",icon:r.jsx(te,{}),size:"small",onClick:()=>Q(s),disabled:s.isDisplay,className:"display-button",children:r.jsx("span",{className:"button-text",children:s.isDisplay?"បង្ហាញ":"កំណត់ជាបង្ហាញ"})})}),r.jsx(B,{type:"text",icon:r.jsx(re,{}),danger:!0,size:"small",onClick:()=>{const t=async()=>{if(await K(s)){const d=o.filter(m=>m.uid!==s.uid);f(d),G({fileList:d})}};H.confirm({title:"តើអ្នកពិតជាចង់លុបកិច្ចសន្យានេះមែនទេ?",content:"សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ។",okText:"យល់ព្រម",cancelText:"បោះបង់",onOk:t})}})]})]},s.uid))}),r.jsx(ie,{listType:"picture-card",fileList:[],customRequest:q,onChange:G,onPreview:M,multiple:!0,maxCount:O,disabled:z||o.length>=O,accept:".jpg,.jpeg,.png,.pdf",className:"file-upload-button",showUploadList:!1,children:o.length>=O?null:X}),r.jsx(H,{open:V,title:k,footer:null,onCancel:()=>$(!1),children:U&&(U.endsWith(".pdf")?r.jsx("iframe",{src:U,style:{width:"100%",height:"500px"},title:k}):r.jsx("img",{alt:k,style:{width:"100%"},src:U}))}),z&&r.jsx("div",{className:"upload-loading",children:r.jsx(oe,{tip:"កំពុងផ្ទុកឡើង...",size:"large",children:r.jsx("div",{className:"content"})})})]})}export{De as F};
