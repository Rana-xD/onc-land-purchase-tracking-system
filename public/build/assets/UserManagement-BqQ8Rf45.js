import{j as e,Q as P,r as t,d as x}from"./app-D0OhDuOP.js";import{A as E,B as N}from"./AdminLayout-DfyZC7U7.js";import{F as c}from"./index-01QrSur2.js";import{C as $}from"./index-BXZQm44E.js";import{R as ie,C as g}from"./row-Cvvd4www.js";import{I as m}from"./index-DyIYvMCA.js";import{S as p}from"./index-BXlDNFm_.js";import{B as f,T as _}from"./index-XQ9uBlxv.js";import{R as ce}from"./ReloadOutlined-Dtwtuc-j.js";import{R as de}from"./UserAddOutlined-tNPDV1QR.js";import{S as me}from"./index-Bjcdw0HM.js";import{F as pe}from"./Table-CJMywyvl.js";import{M as z}from"./index-DSx0c0nZ.js";import{s as l}from"./index-VXrvBi_7.js";import{T as ue}from"./index-DxlGwFBo.js";import{S as xe}from"./index-CpY42lHj.js";import{R as he}from"./EditOutlined-BQAB7wjt.js";import{R as ge}from"./StopOutlined-EZc5FRiH.js";import{R as fe}from"./CheckCircleOutlined-_P5yC29H.js";import{P as je}from"./index-BLwNk9Dd.js";import{R as ve}from"./DeleteOutlined-C5fTVnAq.js";import"./UserOutlined-Bw1Yg3TV.js";import"./index-BKPGZTnh.js";import"./EllipsisOutlined-BcUT9_x5.js";import"./PurePanel-BrlMViLC.js";import"./index-BoUcoXbW.js";import"./CheckOutlined-C-W3vkf9.js";import"./ExclamationCircleFilled-BuCwC-hN.js";import"./CloseOutlined-CSg-7HVH.js";import"./Skeleton-BB1PfEPR.js";import"./useVariants-VmmnPvRy.js";import"./index-BNYa27A7.js";import"./getAllowClear-7r21EHJH.js";import"./Input-DIi4XD1o.js";import"./pickAttrs-BMtZpb9Y.js";import"./EyeOutlined-Bk9sN1n5.js";import"./SearchOutlined-DdbS1Qlk.js";import"./useIcons-De8HtjeC.js";import"./DownOutlined-BKT6hG3e.js";import"./addEventListener-Dvq9iQDE.js";import"./index-CxyNWzZ_.js";import"./useBubbleLock-Dp5g0NxF.js";import"./index-HowiUfuo.js";import"./Pagination-C28t5-1k.js";import"./extendsObject-78o_rR5W.js";import"./FileOutlined-CmtzEeI9.js";import"./FolderOutlined-CsvjmU0T.js";import"./InfoCircleFilled-Csbq1HVY.js";import"./ActionButton-DPI_9ZHB.js";import"./useClosable-rmjEiMr1.js";function Ss({auth:o}){var k,T,F,O;if(!(((T=(k=o==null?void 0:o.user)==null?void 0:k.assigned_role)==null?void 0:T.name)==="admin"||((O=(F=o==null?void 0:o.user)==null?void 0:F.assigned_role)==null?void 0:O.name)==="manager"))return e.jsxs(E,{children:[e.jsx(P,{title:"មិនមានសិទ្ធិ"}),e.jsx("div",{className:"py-12",children:e.jsx("div",{className:"max-w-7xl mx-auto sm:px-6 lg:px-8",children:e.jsx("div",{className:"bg-white overflow-hidden shadow-sm sm:rounded-lg",children:e.jsxs("div",{className:"p-6 text-gray-900",children:[e.jsx("h1",{className:"text-2xl font-bold mb-4 text-red-600",children:"មិនមានសិទ្ធិ"}),e.jsx("p",{children:"អ្នកមិនមានសិទ្ធិចូលប្រើប្រាស់ទំព័រនេះទេ។"})]})})})})]});const[A,U]=t.useState([]),[q,b]=t.useState(!0),[w,B]=t.useState({current:1,pageSize:10,total:0}),[Se,ye]=t.useState(""),[_e,be]=t.useState("");t.useRef(null);const[L,S]=t.useState(!1),[Q,y]=t.useState(!1),[j]=c.useForm(),[i,D]=t.useState(null),[h,C]=t.useState(null),[n,R]=t.useState({search:"",role:"all",status:"all"}),[K,V]=t.useState([]),d=async(s={})=>{b(!0);try{const{page:r=1,search:a=n.search,role:u=n.role,status:M=n.status}=s,v=await x.get("/api/users",{params:{page:r,search:a,role:u,status:M}});U(v.data.data),B({current:v.data.current_page,pageSize:v.data.per_page,total:v.data.total}),R({search:a,role:u,status:M})}catch(r){console.error("Error fetching users:",r),l.error("មានបញ្ហាក្នុងការទាញយកទិន្នន័យអ្នកប្រើប្រាស់")}finally{b(!1)}},Z=async()=>{try{const s=await x.get("/api/roles/for-select");V(s.data.data||[])}catch(s){console.error("Error fetching roles:",s)}};t.useEffect(()=>{d(),Z()},[]);const G=s=>{d({page:s.current,...n})},H=s=>{d({search:s,page:1})},J=s=>{d({role:s,page:1})},W=s=>{d({status:s,page:1})},X=()=>{d({search:"",role:"all",status:"all",page:1})},I=(s=null)=>{D(s),S(!0),s?j.setFieldsValue({name:s.name,username:s.username,role_id:s.role_id,is_active:s.is_active}):j.resetFields()},Y=s=>{C(s),y(!0)},ee=async()=>{try{const s=await j.validateFields();i?(await x.put(`/api/users/${i.id}`,s),l.success("អ្នកប្រើប្រាស់ត្រូវបានកែប្រែដោយជោគជ័យ")):(await x.post("/api/users",s),l.success("អ្នកប្រើប្រាស់ត្រូវបានបង្កើតដោយជោគជ័យ")),S(!1),d(n)}catch(s){if(s.response&&s.response.data&&s.response.data.message)l.error(s.response.data.message);else if(s.response&&s.response.data&&s.response.data.errors){const r=s.response.data.errors;Object.values(r).flat().forEach(u=>l.error(u))}else l.error("មានបញ្ហាក្នុងការរក្សាទុកទិន្នន័យ")}},se=()=>{S(!1)},re=()=>{y(!1),C(null)},ae=async()=>{try{await x.post(`/api/users/${h.id}/toggle-status`),l.success("ស្ថានភាពអ្នកប្រើប្រាស់ត្រូវបានផ្លាស់ប្តូរដោយជោគជ័យ"),y(!1),d(n)}catch(s){s.response&&s.response.data&&s.response.data.message?l.error(s.response.data.message):l.error("មានបញ្ហាក្នុងការផ្លាស់ប្តូរស្ថានភាព")}},te=async s=>{try{await x.delete(`/api/users/${s}`),l.success("អ្នកប្រើប្រាស់ត្រូវបានលុបដោយជោគជ័យ"),d(n)}catch(r){r.response&&r.response.data&&r.response.data.message?l.error(r.response.data.message):l.error("មានបញ្ហាក្នុងការលុបអ្នកប្រើប្រាស់")}},oe=s=>{switch(s){case"administrator":return"red";case"manager":return"blue";case"staff":return"green";default:return"default"}},le=s=>{switch(s){case"administrator":return"អេតមីន";case"manager":return"អ្នកគ្រប់គ្រង";case"staff":return"បុគ្គលិក";default:return s}},ne=[{title:"ល.រ",key:"index",width:60,render:(s,r,a)=>(w.current-1)*w.pageSize+a+1},{title:"ឈ្មោះ",dataIndex:"name",key:"name",sorter:(s,r)=>s.name.localeCompare(r.name)},{title:"ឈ្មោះគណនី",dataIndex:"username",key:"username"},{title:"តួនាទី",dataIndex:"role",key:"role",render:(s,r)=>{const a=r.assigned_role?r.assigned_role.display_name:le(s),u=r.assigned_role?"blue":oe(s);return e.jsx(ue,{color:u,children:a})}},{title:"ស្ថានភាព",dataIndex:"is_active",key:"is_active",render:s=>s?e.jsx(N,{status:"success",text:"សកម្ម"}):e.jsx(N,{status:"error",text:"អសកម្ម"})},{title:"សកម្មភាព",key:"action",render:(s,r)=>{var a;return e.jsxs(xe,{size:"small",children:[e.jsx(_,{title:"កែប្រែ",children:e.jsx(f,{type:"primary",icon:e.jsx(he,{}),size:"small",onClick:()=>I(r),disabled:o.user.id===r.id&&!((a=o.user.assigned_role)!=null&&a.name)==="administrator"})}),e.jsx(_,{title:r.is_active?"បិទគណនី":"បើកគណនី",children:e.jsx(f,{type:r.is_active?"default":"primary",icon:r.is_active?e.jsx(ge,{}):e.jsx(fe,{}),size:"small",onClick:()=>Y(r),danger:r.is_active,disabled:o.user.id===r.id})}),o.user.id!==r.id&&e.jsx(_,{title:"លុប",children:e.jsx(je,{title:"តើអ្នកពិតជាចង់លុបអ្នកប្រើប្រាស់នេះមែនទេ?",description:"សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ",onConfirm:()=>te(r.id),okText:"បាទ/ចាស",cancelText:"ទេ",children:e.jsx(f,{danger:!0,icon:e.jsx(ve,{}),size:"small"})})})]})}}];return e.jsxs(E,{title:"គ្រប់គ្រងអ្នកប្រើប្រាស់",children:[e.jsx(P,{title:"គ្រប់គ្រងអ្នកប្រើប្រាស់"}),e.jsx($,{className:"mb-4",children:e.jsxs(ie,{gutter:16,align:"middle",children:[e.jsx(g,{xs:24,sm:8,md:6,lg:6,xl:5,children:e.jsx(m.Search,{placeholder:"ស្វែងរកតាមឈ្មោះ ឬឈ្មោះគណនី",allowClear:!0,enterButton:!0,value:n.search,onChange:s=>R({...n,search:s.target.value}),onSearch:H})}),e.jsx(g,{xs:24,sm:8,md:5,lg:4,xl:3,children:e.jsx(p,{placeholder:"តួនាទី",style:{width:"100%"},value:n.role,onChange:J,options:[{value:"all",label:"តួនាទីទាំងអស់"},{value:"administrator",label:"អ្នកគ្រប់គ្រងប្រព័ន្ធ"},{value:"manager",label:"អ្នកគ្រប់គ្រង"},{value:"staff",label:"បុគ្គលិក"}]})}),e.jsx(g,{xs:24,sm:8,md:5,lg:4,xl:3,children:e.jsx(p,{placeholder:"ស្ថានភាព",style:{width:"100%"},value:n.status,onChange:W,options:[{value:"all",label:"ស្ថានភាពទាំងអស់"},{value:"active",label:"សកម្ម"},{value:"inactive",label:"អសកម្ម"}]})}),e.jsx(g,{xs:24,sm:8,md:4,lg:3,xl:3,children:e.jsx(f,{icon:e.jsx(ce,{}),onClick:X,children:"កំណត់ឡើងវិញ"})}),e.jsx(g,{xs:24,sm:16,md:4,lg:7,xl:10,className:"text-right",children:e.jsx(f,{type:"primary",icon:e.jsx(de,{}),onClick:()=>I(),children:"បង្កើតអ្នកប្រើប្រាស់ថ្មី"})})]})}),e.jsx($,{children:e.jsx(me,{spinning:q,children:e.jsx(pe,{columns:ne,dataSource:A,rowKey:"id",pagination:w,onChange:G,scroll:{x:"max-content"}})})}),e.jsx(z,{title:i?"កែប្រែអ្នកប្រើប្រាស់":"បង្កើតអ្នកប្រើប្រាស់ថ្មី",open:L,onOk:ee,onCancel:se,okText:i?"កែប្រែ":"បង្កើត",cancelText:"បោះបង់",maskClosable:!1,children:e.jsxs(c,{form:j,layout:"vertical",name:"userForm",children:[e.jsx(c.Item,{name:"name",label:"ឈ្មោះ",rules:[{required:!0,message:"សូមបញ្ចូលឈ្មោះ!"}],children:e.jsx(m,{})}),e.jsx(c.Item,{name:"username",label:"ឈ្មោះគណនី",rules:[{required:!0,message:"សូមបញ្ចូលឈ្មោះគណនី!"},{min:3,message:"ឈ្មោះគណនីត្រូវមានយ៉ាងតិច ៣ តួអក្សរ!"},{pattern:/^[a-zA-Z0-9_-]+$/,message:"ឈ្មោះគណនីអាចមានតែអក្សរ លេខ និងសញ្ញា _ ឬ - ប៉ុណ្ណោះ!"}],children:e.jsx(m,{})}),!i&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"password",label:"ពាក្យសម្ងាត់",rules:[{required:!0,message:"សូមបញ្ចូលពាក្យសម្ងាត់!"}],children:e.jsx(m.Password,{})}),e.jsx(c.Item,{name:"password_confirmation",label:"បញ្ជាក់ពាក្យសម្ងាត់",dependencies:["password"],rules:[{required:!0,message:"សូមបញ្ជាក់ពាក្យសម្ងាត់!"},({getFieldValue:s})=>({validator(r,a){return!a||s("password")===a?Promise.resolve():Promise.reject(new Error("ពាក្យសម្ងាត់ទាំងពីរមិនត្រូវគ្នា!"))}})],children:e.jsx(m.Password,{})})]}),i&&e.jsxs(e.Fragment,{children:[e.jsx(c.Item,{name:"password",label:"ពាក្យសម្ងាត់ថ្មី (ទុកទទេបើមិនចង់ផ្លាស់ប្តូរ)",rules:[{min:6,message:"ពាក្យសម្ងាត់ត្រូវមានយ៉ាងតិច ៦ តួអក្សរ!",validateTrigger:"onChange"}],children:e.jsx(m.Password,{})}),e.jsx(c.Item,{name:"password_confirmation",label:"បញ្ជាក់ពាក្យសម្ងាត់ថ្មី",dependencies:["password"],rules:[({getFieldValue:s})=>({validator(r,a){return!s("password")||!a||s("password")===a?Promise.resolve():Promise.reject(new Error("ពាក្យសម្ងាត់ទាំងពីរមិនត្រូវគ្នា!"))}})],children:e.jsx(m.Password,{})})]}),e.jsx(c.Item,{name:"role_id",label:"តួនាទី",rules:[{required:!0,message:"សូមជ្រើសរើសតួនាទី!"}],children:e.jsx(p,{placeholder:"ជ្រើសរើសតួនាទី",disabled:i&&o.user.id===i.id,showSearch:!0,filterOption:(s,r)=>r.children.toLowerCase().indexOf(s.toLowerCase())>=0,children:K.map(s=>e.jsx(p.Option,{value:s.id,children:s.display_name},s.id))})}),i&&e.jsx(c.Item,{name:"is_active",label:"ស្ថានភាព",valuePropName:"checked",initialValue:!0,children:e.jsxs(p,{disabled:o.user.id===i.id,children:[e.jsx(p.Option,{value:!0,children:"សកម្ម"}),e.jsx(p.Option,{value:!1,children:"អសកម្ម"})]})})]})}),e.jsx(z,{title:"បញ្ជាក់ការផ្លាស់ប្តូរស្ថានភាព",open:Q,onOk:ae,onCancel:re,okText:"បញ្ជាក់",cancelText:"បោះបង់",children:h&&e.jsxs("p",{children:["តើអ្នកពិតជាចង់",h.is_active?"បិទ":"បើក","គណនីរបស់",e.jsxs("strong",{children:[" ",h.name]})," (",h.username,") មែនទេ?"]})})]})}export{Ss as default};
