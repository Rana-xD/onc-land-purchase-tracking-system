import{r as c,e as w,s as m,j as e,t as L,Q as T,B as R,R as U}from"./app-BBTICp4j.js";import{A as W}from"./AdminLayout-DxDDGS0e.js";import{h as $}from"./moment-C5S46NFB.js";import{T as Y}from"./index-Cfh7qGRB.js";import{S as D,E as P}from"./index-mLV1oJws.js";import{R as z}from"./FileExcelOutlined-CjheT0Db.js";import{R as B}from"./FilePdfOutlined-BnRZPQ4O.js";import{A as H}from"./index-DW0SOg5n.js";import{S as M}from"./index-CcJgjeQ-.js";import{F as s}from"./Table-BNh4n8r6.js";import"./UserOutlined-B9ZAOThG.js";import"./index-D88NIlOR.js";import"./index-C5oWf6N6.js";import"./EllipsisOutlined-Bhf9hnSZ.js";import"./PurePanel-DnHFRN3c.js";import"./index-BLi1CBmm.js";import"./EditOutlined-DhdXE3k2.js";import"./getAllowClear-DLCbMek5.js";import"./useVariants-Bsn3ZCEZ.js";import"./CheckOutlined-DMU6mItx.js";import"./useIcons-DLppMF82.js";import"./DownOutlined-CIxjOa2g.js";import"./SearchOutlined-DJlkhe1H.js";import"./addEventListener-ungWzbhy.js";import"./index-BTHh_Gpg.js";import"./useBubbleLock-ClpRCOWH.js";import"./index-AFDIk0Sd.js";import"./Pagination-CRn34H2T.js";import"./FileOutlined-Bkjwbk_U.js";import"./FolderOutlined-BtKR_-vO.js";import"./Input-BDTvmsS1.js";const{Title:kt,Text:n}=Y,E={totalColumnHeader:{backgroundColor:"#f0f5ff",fontWeight:"bold"},totalColumn:{backgroundColor:"#f9f9ff"}},wt=({auth:N})=>{const[p,u]=c.useState(!1),[h,x]=c.useState(!1),[y,f]=c.useState(null),[i,g]=c.useState(null),[j,_]=c.useState(null),[d,I]=c.useState($().year()),l=t=>t==null?"$0.00":"$"+new Intl.NumberFormat("en-US").format(t),b=c.useCallback(async t=>{u(!0),_(null),g(null);try{const r=await w.post("/reports/yearly/data",{year:t});console.log("Yearly report data:",r.data),r.data&&r.data.contracts&&(r.data.contracts=r.data.contracts.map(a=>(console.log("Contract lands:",a.lands),a))),g(r.data)}catch(r){console.error("Error fetching yearly report data:",r),_(r.response&&r.response.data&&r.response.data.error?r.response.data.error:"Failed to fetch report data"),m.error("Failed to load yearly report data. Please refresh the page.")}finally{u(!1)}},[]);c.useEffect(()=>{b(d)},[b,d]);const C=c.useCallback(async t=>{x(!0),f(t),m.loading(`Preparing ${t.toUpperCase()} export...`);try{const r=await w.post("/reports/yearly/export",{format:t,year:d},{responseType:"blob"}),a=new Blob([r.data],{type:t==="excel"?"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet":"application/pdf"}),o=document.createElement("a");o.href=window.URL.createObjectURL(a),o.download=`yearly_report_${d}.${t==="excel"?"xlsx":"pdf"}`,document.body.appendChild(o),o.click(),document.body.removeChild(o),m.success(`${t.toUpperCase()} export completed successfully`)}catch(r){console.error(`Error exporting ${t}:`,r),m.error(`Failed to export ${t.toUpperCase()}. Please try again.`)}finally{x(!1),f(null)}},[d]),v=t=>{I(t)},S=[],k=$().year();for(let t=k-5;t<=k;t++)S.push({value:t,label:t});const A=[{title:"លេខកិច្ចសន្យា",dataIndex:"contract_id",key:"contract_id",fixed:"left",width:150,align:"center",render:t=>e.jsx(L,{href:`/reports/document?contract_id=${t}`,className:"text-blue-600 hover:text-blue-800 font-bold",children:t})},{title:"ដីឡូត៍",dataIndex:"lands",key:"lands",fixed:"left",width:150,align:"center",render:(t,r)=>!t||t.length===0?e.jsx(n,{children:"-"}):e.jsx("div",{children:t.map((a,o)=>e.jsx("div",{children:e.jsx(n,{children:a.plot_number||"N/A"})},`land_${o}`))})},...(()=>{const t=[];for(let r=1;r<=12;r++)t.push({title:`${r.toString().padStart(2,"0")}/${d.toString().slice(-2)}`,align:"center",children:[{title:"បានបង់",dataIndex:["monthly_data",r,"paid"],key:`month_${r}_paid`,width:100,align:"center",render:a=>e.jsx(n,{style:{color:"#52c41a",display:"block",textAlign:"right"},children:l(a||0)})},{title:"មិនទាន់បង់",dataIndex:["monthly_data",r,"unpaid"],key:`month_${r}_unpaid`,width:100,align:"center",render:a=>e.jsx(n,{style:{color:"#f5222d",display:"block",textAlign:"right"},children:l(a||0)})}]});return t})(),{title:"ទឹកប្រាក់សរុប",align:"center",className:"total-column-header",children:[{title:"បានបង់",dataIndex:"paid_amount",key:"paid_amount",width:120,align:"center",className:"total-column",render:t=>e.jsx(n,{style:{color:"#52c41a",display:"block",textAlign:"right"},children:l(t||0)})},{title:"មិនទាន់បង់",dataIndex:"unpaid_amount",key:"unpaid_amount",width:120,align:"center",className:"total-column",render:t=>e.jsx(n,{style:{color:"#f5222d",display:"block",textAlign:"right"},children:l(t||0)})},{title:"សរុប",dataIndex:"total_amount",key:"total_amount",width:120,align:"center",className:"total-column",render:t=>e.jsx(n,{strong:!0,style:{fontSize:"16px",display:"block",textAlign:"right"},children:l(t||0)})}]}],F=()=>{if(!i||!i.contracts||i.contracts.length===0)return null;const t=i.summary,r={key:"summary",contract_id:e.jsx(n,{strong:!0,children:"សរុប"}),lands:e.jsxs(n,{strong:!0,children:[t.lands_count," ឡូត៍"]}),paid_amount:t.paid_amount,unpaid_amount:t.unpaid_amount,total_amount:t.total_amount,monthly_data:{}};for(let a=1;a<=12;a++)r.monthly_data[a]={paid:0,unpaid:0};return i.contracts.forEach(a=>{for(let o=1;o<=12;o++)r.monthly_data[o].paid+=a.monthly_data[o].paid,r.monthly_data[o].unpaid+=a.monthly_data[o].unpaid}),r};return e.jsxs(W,{user:N.user,children:[e.jsx(T,{title:"របាយការណ៍ប្រចាំឆ្នាំ"}),e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"របាយការណ៍ប្រចាំឆ្នាំ"}),e.jsxs("div",{children:[e.jsx(D,{defaultValue:d,value:d,onChange:v,style:{width:120,marginRight:16},options:S}),e.jsx(R,{type:"primary",style:{backgroundColor:"#52c41a",marginRight:8},icon:e.jsx(z,{}),onClick:()=>C("excel"),loading:h&&y==="excel",children:"Excel"}),e.jsx(R,{icon:e.jsx(B,{}),onClick:()=>C("pdf"),loading:h&&y==="pdf",children:"PDF"})]})]}),j&&e.jsx(H,{message:"Error",description:j,type:"error",showIcon:!0,className:"mb-4"}),p?e.jsx("div",{className:"flex justify-center items-center",style:{height:"400px"},children:e.jsx(M,{size:"large",tip:"កំពុងដំណើរការ..."})}):e.jsx("div",{className:"yearly-report-container",children:i&&i.contracts&&i.contracts.length>0?e.jsx(s,{dataSource:i.contracts,columns:A,rowKey:"contract_id",scroll:{x:"max-content"},pagination:!1,bordered:!0,size:"middle",loading:p,className:"yearly-report-table",onHeaderRow:t=>t.className==="total-column-header"?{style:E.totalColumnHeader}:{},onCell:(t,r,a)=>a&&a.className==="total-column"?{style:E.totalColumn}:{},summary:()=>{const t=F();return t?e.jsx(s.Summary,{fixed:!0,children:e.jsxs(s.Summary.Row,{style:{backgroundColor:"#fafafa",fontWeight:"bold"},children:[e.jsx(s.Summary.Cell,{index:0,fixed:"left",children:t.contract_id}),e.jsx(s.Summary.Cell,{index:1,fixed:"left",children:t.lands}),Object.keys(t.monthly_data).map(r=>e.jsxs(U.Fragment,{children:[e.jsx(s.Summary.Cell,{index:parseInt(r)*2,align:"right",children:e.jsx(n,{style:{color:"#52c41a",fontWeight:"bold"},children:l(t.monthly_data[r].paid)})}),e.jsx(s.Summary.Cell,{index:parseInt(r)*2+1,align:"right",children:e.jsx(n,{style:{color:"#f5222d",fontWeight:"bold"},children:l(t.monthly_data[r].unpaid)})})]},`summary_${r}`)),e.jsx(s.Summary.Cell,{index:25,align:"right",children:e.jsx(n,{style:{color:"#52c41a",fontWeight:"bold"},children:l(t.paid_amount)})}),e.jsx(s.Summary.Cell,{index:26,align:"right",children:e.jsx(n,{style:{color:"#f5222d",fontWeight:"bold"},children:l(t.unpaid_amount)})}),e.jsx(s.Summary.Cell,{index:27,align:"right",children:e.jsx(n,{strong:!0,children:l(t.total_amount)})})]})}):null}}):e.jsx(P,{description:e.jsxs("span",{children:["គ្មានទិន្នន័យសម្រាប់ឆ្នាំ ",d]})})})]})]})};export{wt as default};
