import{r as h,j as e,a as E,s as w,t as W,Q as $,B as D,R as P}from"./app-C81v863Z.js";import{A as z}from"./AdminLayout-4hWCCW4J.js";import{h as L}from"./moment-C5S46NFB.js";import{u as O,R as V}from"./useHTMLToPDF-cIRtCsKS.js";import{T as Y}from"./index-DVx3a9qR.js";import{S as K,E as U}from"./index-CXKhVvIi.js";import{R as M}from"./FilePdfOutlined-DEIi5Lbm.js";import{A as G}from"./index-DZaRE5GC.js";import{S as Q}from"./index-alDFd_10.js";import{F as g}from"./Table-9Jun1Fn2.js";import"./UserOutlined-Cs_VmhTJ.js";import"./index-hGIK_HDO.js";import"./index-BDtS0eMa.js";import"./EllipsisOutlined-Dgx-5LTE.js";import"./PurePanel-B9LZ7YRU.js";import"./index-0iedL70p.js";import"./InboxOutlined-NtB6O71W.js";import"./EditOutlined-Dt25MYJV.js";import"./getAllowClear-YBVvCZBt.js";import"./useVariants-DiVBn6uh.js";import"./CheckOutlined-BtpNa_G2.js";import"./useIcons-Bcyu7X2C.js";import"./DownOutlined-Bis42zyM.js";import"./SearchOutlined-rZRKH8d_.js";import"./addEventListener-CGfbZz05.js";import"./index-Dyio-8w4.js";import"./useBubbleLock-g9XhDwJl.js";import"./index-BXobfGdR.js";import"./Pagination-CQl1u3Ip.js";import"./FileOutlined-CLduoszu.js";import"./FolderOutlined-D8jm1l7w.js";import"./Input-BSKYPgzP.js";const q=({data:o,year:I,exportedBy:A})=>{var i,H,k;const[v,T]=h.useState([]),[B,_]=h.useState(!1),s=h.useRef(null),R=()=>{if(!s.current)return;_(!0);const a=s.current.querySelectorAll("[data-section]"),c=1056,x=[];a.forEach((u,f)=>{const j=u.getBoundingClientRect(),b=u.offsetTop,y=j.height,C=b%c;if(C+y>c&&C>100){const N=c-C;x.push({sectionIndex:f,marginTop:N+20})}}),T(x),_(!1)};h.useEffect(()=>{s.current&&(s.current.calculatePageBreaks=R)},[]);const p=a=>new Intl.NumberFormat("km-KH",{style:"currency",currency:"USD",minimumFractionDigits:2}).format(a||0),t={container:{fontFamily:'"Noto Sans Khmer", "Khmer OS", sans-serif',fontSize:"14px",lineHeight:"1.6",color:"#333",backgroundColor:"#fff",padding:"40px",maxWidth:"210mm",margin:"0 auto"},header:{textAlign:"center",marginBottom:"40px",borderBottom:"3px solid #333",paddingBottom:"20px"},title:{fontSize:"28px",fontWeight:"bold",marginBottom:"10px",color:"#333"},subtitle:{fontSize:"18px",marginBottom:"10px",color:"#666"},exportInfo:{textAlign:"right",fontSize:"12px",color:"#666",marginBottom:"20px"},section:{marginBottom:"30px",pageBreakInside:"avoid",breakInside:"avoid"},sectionTitle:{fontSize:"20px",fontWeight:"bold",marginBottom:"15px",color:"#333",backgroundColor:"#f8f9fa",padding:"12px",borderLeft:"4px solid #28a745"},summaryGrid:{display:"grid",gridTemplateColumns:"repeat(auto-fit, minmax(200px, 1fr))",gap:"15px",marginBottom:"20px"},summaryCard:{display:"flex",alignItems:"center",padding:"15px",backgroundColor:"#f8f9fa",borderRadius:"8px",border:"1px solid #dee2e6",gap:"12px"},summaryIcon:{fontSize:"24px",minWidth:"30px"},summaryLabel:{fontWeight:"bold",color:"#495057"},summaryValue:{color:"#28a745",fontWeight:"bold"},table:{width:"100%",borderCollapse:"collapse",marginTop:"15px",pageBreakInside:"avoid",breakInside:"avoid"},tableHeader:{backgroundColor:"#28a745",color:"white"},tableHeaderCell:{padding:"12px",textAlign:"center",fontWeight:"bold",border:"1px solid #dee2e6"},tableCell:{padding:"10px",textAlign:"center",border:"1px solid #dee2e6"},tableRow:{backgroundColor:"#fff"},tableRowAlt:{backgroundColor:"#f8f9fa"},noData:{textAlign:"center",padding:"20px",color:"#6c757d",fontStyle:"italic"},footer:{textAlign:"center",marginTop:"40px",fontSize:"12px",color:"#6c757d",borderTop:"1px solid #dee2e6",paddingTop:"20px"},divider:{borderTop:"1px solid #333",margin:"20px 0"},keepTogether:{pageBreakInside:"avoid",breakInside:"avoid"}};return e.jsxs("div",{ref:s,style:t.container,children:[e.jsxs("div",{style:t.header,children:[e.jsx("h1",{style:t.title,children:"ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†"}),e.jsxs("p",{style:t.subtitle,children:["á†áŸ’á“á¶áŸ† ",I||"2025"]}),e.jsx("hr",{style:t.divider}),e.jsxs("div",{style:t.exportInfo,children:[e.jsx("p",{children:"á“á¶á™á€áŠáŸ’á‹á¶á“: áŸáŸáœá¶"}),e.jsxs("p",{children:["á€á¶á›á”ášá·á…áŸ’á†áŸá‘á“á¶áŸ†á…áŸá‰: ",new Date().toLocaleDateString("km-KH")]})]})]}),e.jsx("div",{"data-section":"summary",style:{...t.section,marginTop:((i=v.find(a=>a.sectionIndex===0))==null?void 0:i.marginTop)||0},children:e.jsxs("div",{style:t.keepTogether,children:[e.jsx("h2",{style:t.sectionTitle,children:"ğŸ“Š áŸá„áŸ’ááŸá”"}),e.jsxs("div",{style:t.summaryGrid,children:[e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.summaryIcon,children:"ğŸ“„"}),e.jsxs("div",{children:[e.jsx("div",{style:t.summaryLabel,children:"áŸá‰áŸ’á‰á¶áŸášá»á”:"}),e.jsx("div",{style:t.summaryValue,children:o.total_contracts||1})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.summaryIcon,children:"ğŸ’°"}),e.jsxs("div",{children:[e.jsx("div",{style:t.summaryLabel,children:"á…áŸ†á“á½á“áŸášá»á”:"}),e.jsx("div",{style:t.summaryValue,children:p(o.total_amount||32e3)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.summaryIcon,children:"âœ…"}),e.jsxs("div",{children:[e.jsx("div",{style:t.summaryLabel,children:"á”á¶á“á‘á¼á‘á¶ááŸ‹:"}),e.jsx("div",{style:t.summaryValue,children:p(o.paid_amount||0)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.summaryIcon,children:"âŒ"}),e.jsxs("div",{children:[e.jsx("div",{style:t.summaryLabel,children:"á˜á·á“á‘á¶á“á‘á¼á‘á¶ááŸ‹:"}),e.jsx("div",{style:t.summaryValue,children:p(o.unpaid_amount||32e3)})]})]}),e.jsxs("div",{style:t.summaryCard,children:[e.jsx("div",{style:t.summaryIcon,children:"ğŸï¸"}),e.jsxs("div",{children:[e.jsx("div",{style:t.summaryLabel,children:"áŠá¸áŸášá»á”:"}),e.jsx("div",{style:t.summaryValue,children:o.total_lands||1})]})]})]})]})}),e.jsx("div",{"data-section":"contracts",style:{...t.section,marginTop:((H=v.find(a=>a.sectionIndex===1))==null?void 0:H.marginTop)||0},children:e.jsxs("div",{style:t.keepTogether,children:[e.jsx("h2",{style:t.sectionTitle,children:"ğŸ“‹ á”á‰áŸ’á‡á¸á€á·á…áŸ’á…áŸá“áŸ’á™á¶"}),e.jsxs("table",{style:t.table,children:[e.jsx("thead",{style:t.tableHeader,children:e.jsxs("tr",{children:[e.jsx("th",{style:t.tableHeaderCell,children:"á›áŸáá€á·á…áŸ’á…áŸá“áŸ’á™á¶"}),e.jsx("th",{style:t.tableHeaderCell,children:"á›áŸááŠá¸á’áŸ’á›á¸"}),e.jsx("th",{style:t.tableHeaderCell,children:"á…áŸ†á“á½á“áŸášá»á”"}),e.jsx("th",{style:t.tableHeaderCell,children:"á”á¶á“á‘á¼á‘á¶ááŸ‹"}),e.jsx("th",{style:t.tableHeaderCell,children:"á˜á·á“á‘á¶á“á‘á¼á‘á¶ááŸ‹"}),e.jsx("th",{style:t.tableHeaderCell,children:"áŸáŸ’áá¶á“á—á¶á–"})]})}),e.jsx("tbody",{children:o.contracts&&o.contracts.length>0?o.contracts.map((a,c)=>{const x=Object.values(a.monthly_data||{}).reduce((b,y)=>b+(y.paid||0),0),u=Object.values(a.monthly_data||{}).reduce((b,y)=>b+(y.unpaid||0),0),f=x+u,j=u>0?"á˜á·á“á‘á¶á“áŸ‹á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹":"á”á„áŸ‹á”áŸ’ášá¶á€áŸ‹ášá½á…ášá¶á›áŸ‹";return e.jsxs("tr",{style:c%2===0?t.tableRow:t.tableRowAlt,children:[e.jsx("td",{style:t.tableCell,children:a.contract_id||"N/A"}),e.jsx("td",{style:t.tableCell,children:a.lands&&a.lands.length>0&&a.lands[0].plot_number||"N/A"}),e.jsx("td",{style:t.tableCell,children:p(f)}),e.jsx("td",{style:t.tableCell,children:p(x)}),e.jsx("td",{style:t.tableCell,children:p(u)}),e.jsx("td",{style:{...t.tableCell,color:u>0?"#dc3545":"#28a745",fontWeight:"bold"},children:j})]},c)}):e.jsx("tr",{children:e.jsx("td",{colSpan:"6",style:t.noData,children:"á˜á·á“á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá‰áŸ’á‰á¶áŸá˜áŸ’ášá¶á”áŸ‹á†áŸ’á“á¶áŸ†á“áŸáŸ‡"})})})]})]})}),e.jsx("div",{"data-section":"monthly-summary",style:{...t.section,marginTop:((k=v.find(a=>a.sectionIndex===2))==null?void 0:k.marginTop)||0},children:e.jsxs("div",{style:t.keepTogether,children:[e.jsx("h2",{style:t.sectionTitle,children:"ğŸ“… áŸá„áŸ’ááŸá”á”áŸ’ášá…á¶áŸ†ááŸ‚"}),e.jsxs("table",{style:t.table,children:[e.jsx("thead",{style:t.tableHeader,children:e.jsxs("tr",{children:[e.jsx("th",{style:t.tableHeaderCell,children:"ááŸ‚"}),e.jsx("th",{style:t.tableHeaderCell,children:"á…áŸ†á“á½á“á€á·á…áŸ’á…áŸá“áŸ’á™á¶"}),e.jsx("th",{style:t.tableHeaderCell,children:"á…áŸ†á“á½á“áŸášá»á”"}),e.jsx("th",{style:t.tableHeaderCell,children:"á”á¶á“á‘á¼á‘á¶ááŸ‹"}),e.jsx("th",{style:t.tableHeaderCell,children:"á˜á·á“á‘á¶á“á‘á¼á‘á¶ááŸ‹"})]})}),e.jsx("tbody",{children:[1,2,3,4,5,6,7,8,9,10,11,12].map(a=>{let c=0,x=0,u=0;o.contracts&&o.contracts.forEach(b=>{var C;const y=((C=b.monthly_data)==null?void 0:C[a])||{paid:0,unpaid:0};c+=y.paid||0,x+=y.unpaid||0,((y.paid||0)>0||(y.unpaid||0)>0)&&u++});const f=c+x,j=new Date(2025,a-1,1).toLocaleDateString("km-KH",{month:"long"});return e.jsxs("tr",{style:a%2===0?t.tableRowAlt:t.tableRow,children:[e.jsx("td",{style:t.tableCell,children:j}),e.jsx("td",{style:t.tableCell,children:u}),e.jsx("td",{style:t.tableCell,children:p(f)}),e.jsx("td",{style:t.tableCell,children:p(c)}),e.jsx("td",{style:t.tableCell,children:p(x)})]},a)})})]})]})}),e.jsx("div",{style:t.footer,children:e.jsx("p",{children:"ášá”á¶á™á€á¶ášááŸá“áŸáŸ‡ááŸ’ášá¼áœá”á¶á“á”á„áŸ’á€á¾ááŠáŸ„á™á”áŸ’ášá–áŸá“áŸ’á’áá¶á˜áŠá¶á“áŠá¸á€á˜áŸ’á–á»á‡á¶"})})]})},{Title:Re,Text:d}=Y,F={totalColumnHeader:{backgroundColor:"#f0f5ff",fontWeight:"bold"},totalColumn:{backgroundColor:"#f9f9ff"}},He=({auth:o})=>{const[I,A]=h.useState(!1),[v,T]=h.useState(!1),[B,_]=h.useState(null),[s,R]=h.useState(null),[p,t]=h.useState(null),[i,H]=h.useState(L().year()),{generatePDFFromComponent:k}=O(),a=r=>r==null?"$0.00":"$"+new Intl.NumberFormat("en-US").format(r),c=h.useCallback(async r=>{A(!0),t(null),R(null);try{const l=await E.post("/reports/yearly/data",{year:r});console.log("Yearly report data:",l.data),l.data&&l.data.contracts&&(l.data.contracts=l.data.contracts.map(n=>(console.log("Contract lands:",n.lands),n))),R(l.data)}catch(l){console.error("Error fetching yearly report data:",l),t(l.response&&l.response.data&&l.response.data.error?l.response.data.error:"Failed to fetch report data"),w.error("Failed to load yearly report data. Please refresh the page.")}finally{A(!1)}},[]);h.useEffect(()=>{c(i)},[c,i]);const x=h.useCallback(async r=>{if(!s){w.error("áŸá¼á˜á‘á¶á‰á™á€á‘á·á“áŸ’á“á“áŸá™ášá”á¶á™á€á¶ášááŸá‡á¶á˜á»á“áŸá·á“");return}T(!0),_(r);try{if(r==="pdf"){const l=`yearly_report_${i}.pdf`,n=e.jsx(q,{data:s,year:i,exportedBy:o.user.name}),m=await k(n,l);if(!m.success)throw new Error(m.error);w.success("á“á¶áŸ†á…áŸá‰ PDF á”á¶á“á‡áŸ„á‚á‡áŸá™")}else if(r==="excel"){const l=await E.post("/reports/yearly/export",{format:"excel",year:i},{responseType:"blob"}),n=new Blob([l.data],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"}),m=window.URL.createObjectURL(n),S=document.createElement("a");S.href=m,S.setAttribute("download",`yearly_report_${i}.xlsx`),document.body.appendChild(S),S.click(),document.body.removeChild(S),w.success("á“á¶áŸ†á…áŸá‰ Excel á”á¶á“á‡áŸ„á‚á‡áŸá™")}}catch(l){console.error(`Error exporting report as ${r}:`,l),w.error(`á˜á¶á“á”á‰áŸ’á á¶á€áŸ’á“á»á„á€á¶ášá“á¶áŸ†á…áŸá‰: ${l.message}`)}finally{T(!1),_(null)}},[i,s,o.user.name,k]),u=r=>{H(r)},f=[],j=L().year();for(let r=j-5;r<=j;r++)f.push({value:r,label:r});const C=[{title:"á›áŸáá€á·á…áŸ’á…áŸá“áŸ’á™á¶",dataIndex:"contract_id",key:"contract_id",fixed:"left",width:150,align:"center",render:r=>e.jsx(W,{href:`/reports/document?contract_id=${r}`,className:"text-blue-600 hover:text-blue-800 font-bold",children:r})},{title:"áŠá¸á¡á¼ááŸ",dataIndex:"lands",key:"lands",fixed:"left",width:150,align:"center",render:(r,l)=>!r||r.length===0?e.jsx(d,{children:"-"}):e.jsx("div",{children:r.map((n,m)=>e.jsx("div",{children:e.jsx(d,{children:n.plot_number||"N/A"})},`land_${m}`))})},...(()=>{const r=[];for(let l=1;l<=12;l++)r.push({title:`${l.toString().padStart(2,"0")}/${i.toString().slice(-2)}`,align:"center",children:[{title:"á”á¶á“á”á„áŸ‹",dataIndex:["monthly_data",l,"paid"],key:`month_${l}_paid`,width:100,align:"center",render:n=>e.jsx(d,{style:{color:"#52c41a",display:"block",textAlign:"right"},children:a(n||0)})},{title:"á˜á·á“á‘á¶á“áŸ‹á”á„áŸ‹",dataIndex:["monthly_data",l,"unpaid"],key:`month_${l}_unpaid`,width:100,align:"center",render:n=>e.jsx(d,{style:{color:"#f5222d",display:"block",textAlign:"right"},children:a(n||0)})}]});return r})(),{title:"á‘á¹á€á”áŸ’ášá¶á€áŸ‹áŸášá»á”",align:"center",className:"total-column-header",children:[{title:"á”á¶á“á”á„áŸ‹",dataIndex:"paid_amount",key:"paid_amount",width:120,align:"center",className:"total-column",render:r=>e.jsx(d,{style:{color:"#52c41a",display:"block",textAlign:"right"},children:a(r||0)})},{title:"á˜á·á“á‘á¶á“áŸ‹á”á„áŸ‹",dataIndex:"unpaid_amount",key:"unpaid_amount",width:120,align:"center",className:"total-column",render:r=>e.jsx(d,{style:{color:"#f5222d",display:"block",textAlign:"right"},children:a(r||0)})},{title:"áŸášá»á”",dataIndex:"total_amount",key:"total_amount",width:120,align:"center",className:"total-column",render:r=>e.jsx(d,{strong:!0,style:{fontSize:"16px",display:"block",textAlign:"right"},children:a(r||0)})}]}],N=()=>{if(!s||!s.contracts||s.contracts.length===0)return null;const r=s.summary,l={key:"summary",contract_id:e.jsx(d,{strong:!0,children:"áŸášá»á”"}),lands:e.jsxs(d,{strong:!0,children:[r.lands_count," á¡á¼ááŸ"]}),paid_amount:r.paid_amount,unpaid_amount:r.unpaid_amount,total_amount:r.total_amount,monthly_data:{}};for(let n=1;n<=12;n++)l.monthly_data[n]={paid:0,unpaid:0};return s.contracts.forEach(n=>{for(let m=1;m<=12;m++)l.monthly_data[m].paid+=n.monthly_data[m].paid,l.monthly_data[m].unpaid+=n.monthly_data[m].unpaid}),l};return e.jsxs(z,{user:o.user,children:[e.jsx($,{title:"ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†"}),e.jsxs("div",{style:{padding:"24px"},children:[e.jsxs("div",{className:"flex justify-between items-center mb-4",children:[e.jsx("h1",{className:"text-2xl font-bold",children:"ášá”á¶á™á€á¶ášááŸá”áŸ’ášá…á¶áŸ†á†áŸ’á“á¶áŸ†"}),e.jsxs("div",{children:[e.jsx(K,{defaultValue:i,value:i,onChange:u,style:{width:120,marginRight:16},options:f}),e.jsx(D,{type:"primary",style:{backgroundColor:"#52c41a",marginRight:8},icon:e.jsx(V,{}),onClick:()=>x("excel"),loading:v&&B==="excel",children:"Excel"}),e.jsx(D,{type:"primary",danger:!0,icon:e.jsx(M,{}),onClick:()=>x("pdf"),loading:v&&B==="pdf",children:"PDF"})]})]}),p&&e.jsx(G,{message:"Error",description:p,type:"error",showIcon:!0,className:"mb-4"}),I?e.jsx("div",{className:"flex justify-center items-center",style:{height:"400px"},children:e.jsx(Q,{size:"large",tip:"á€áŸ†á–á»á„áŠáŸ†áá¾ášá€á¶áš..."})}):e.jsx("div",{className:"yearly-report-container",children:s&&s.contracts&&s.contracts.length>0?e.jsx(g,{dataSource:s.contracts,columns:C,rowKey:"contract_id",scroll:{x:"max-content"},pagination:!1,bordered:!0,size:"middle",loading:I,className:"yearly-report-table",onHeaderRow:r=>r.className==="total-column-header"?{style:F.totalColumnHeader}:{},onCell:(r,l,n)=>n&&n.className==="total-column"?{style:F.totalColumn}:{},summary:()=>{const r=N();return r?e.jsx(g.Summary,{fixed:!0,children:e.jsxs(g.Summary.Row,{style:{backgroundColor:"#fafafa",fontWeight:"bold"},children:[e.jsx(g.Summary.Cell,{index:0,fixed:"left",children:r.contract_id}),e.jsx(g.Summary.Cell,{index:1,fixed:"left",children:r.lands}),Object.keys(r.monthly_data).map(l=>e.jsxs(P.Fragment,{children:[e.jsx(g.Summary.Cell,{index:parseInt(l)*2,align:"right",children:e.jsx(d,{style:{color:"#52c41a",fontWeight:"bold"},children:a(r.monthly_data[l].paid)})}),e.jsx(g.Summary.Cell,{index:parseInt(l)*2+1,align:"right",children:e.jsx(d,{style:{color:"#f5222d",fontWeight:"bold"},children:a(r.monthly_data[l].unpaid)})})]},`summary_${l}`)),e.jsx(g.Summary.Cell,{index:25,align:"right",children:e.jsx(d,{style:{color:"#52c41a",fontWeight:"bold"},children:a(r.paid_amount)})}),e.jsx(g.Summary.Cell,{index:26,align:"right",children:e.jsx(d,{style:{color:"#f5222d",fontWeight:"bold"},children:a(r.unpaid_amount)})}),e.jsx(g.Summary.Cell,{index:27,align:"right",children:e.jsx(d,{strong:!0,children:a(r.total_amount)})})]})}):null}}):e.jsx(U,{description:e.jsxs("span",{children:["á‚áŸ’á˜á¶á“á‘á·á“áŸ’á“á“áŸá™áŸá˜áŸ’ášá¶á”áŸ‹á†áŸ’á“á¶áŸ† ",i]})})})]})]})};export{He as default};
