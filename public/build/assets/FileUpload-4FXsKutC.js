import{s as L,r as j,j as t,B as E,a as J}from"./app-C81v863Z.js";import{T as Z}from"./index-DVx3a9qR.js";import{C as I}from"./index-Cq5Cojs-.js";import{T as F}from"./index-BDtS0eMa.js";import{T as ee}from"./index-oMLWggrR.js";import{R as se}from"./EyeOutlined-B_Q_oTAq.js";import{R as te}from"./CheckCircleOutlined-B1TgeDI1.js";import{M as H}from"./index-DhGGMygA.js";import{R as re}from"./DeleteOutlined-CEoMe9ec.js";import{R as ae}from"./FilePdfOutlined-DEIi5Lbm.js";import{R as ne}from"./FileImageOutlined-eYZWO5_j.js";import{U as ie}from"./index-Pphe6XF4.js";import{S as oe}from"./index-alDFd_10.js";import{R as le}from"./UploadOutlined-CroxUJR-.js";const g={success:(p,n=3,i)=>{L.success({content:p,duration:n,onClose:i})},error:(p,n=3,i)=>{L.error({content:p,duration:n,onClose:i})},info:(p,n=3,i)=>{L.info({content:p,duration:n,onClose:i})},warning:(p,n=3,i)=>{L.warning({content:p,duration:n,onClose:i})},loading:(p,n=0,i)=>L.loading({content:p,duration:n,onClose:i})},{Title:pe,Text:ce}=Z,h={fileGridContainer:{display:"grid",gridTemplateColumns:"repeat(auto-fill, minmax(300px, 1fr))",gap:"24px",marginBottom:"24px"},fileCard:{width:"100%",height:"100%",display:"flex",flexDirection:"column"},fileCardCover:{padding:"12px",textAlign:"center",height:"180px",display:"flex",alignItems:"center",justifyContent:"center",overflow:"hidden"},filePreviewImage:{maxHeight:"160px",maxWidth:"100%",objectFit:"contain"},fileIconContainer:{textAlign:"center"},fileIcon:{fontSize:"48px"},fileName:{marginTop:"8px",wordBreak:"break-word",overflow:"hidden",textOverflow:"ellipsis",display:"-webkit-box",WebkitLineClamp:2,WebkitBoxOrient:"vertical"},displayTag:{marginTop:"4px"}};function Le({category:p,referenceId:n=null,initialFiles:i=[],onFilesChange:y,maxFiles:T=2,maxSize:U=10}){const[u,f]=j.useState([]),[B,N]=j.useState(!1),[V,C]=j.useState(!1),[D,z]=j.useState(""),[$,S]=j.useState("");j.useEffect(()=>{if(i&&i.length>0&&u.length===0){const s=i.map(r=>({uid:r.id,name:r.file_name,status:"done",url:`/storage/${r.file_path}`,response:{id:r.id,path:r.file_path},isDisplay:r.is_display,isExisting:!0}));f(s)}},[i]);const W=async s=>{if(s.url){z(s.url),C(!0),S(s.name);return}if(s.originFileObj){const r=await M(s.originFileObj);z(r),C(!0),S(s.name||s.url.substring(s.url.lastIndexOf("/")+1))}},M=s=>new Promise((r,c)=>{const o=new FileReader;o.readAsDataURL(s),o.onload=()=>r(o.result),o.onerror=d=>c(d)}),q=async({file:s,onSuccess:r,onError:c})=>{if(!(s.type==="image/jpeg"||s.type==="image/png"||s.type==="application/pdf")){g.error("អ្នកអាចផ្ទុកឡើងបានតែកិច្ចសន្យាប្រភេទ JPG, PNG, ឬ PDF ប៉ុណ្ណោះ!"),c("File type error");return}if(!(s.size/1024/1024<U)){g.error(`អ្នកអាចផ្ទុកឡើងបានតែកិច្ចសន្យាទំហំតូចជាង ${U}MB ប៉ុណ្ណោះ!`),c("File size error");return}N(!0);try{const e=new FileReader;e.readAsDataURL(s),e.onload=()=>{const m=e.result,b={success:!0,file:{fileName:s.name,base64:m,mimeType:s.type,size:s.size}};r(b),N(!1)},g.success("កិច្ចសន្យាត្រូវបានផ្ទុកឡើងដោយជោគជ័យ")}catch(e){console.error("Error uploading file:",e),g.error("មានបញ្ហាក្នុងការផ្ទុកឡើងកិច្ចសន្យា"),c("Upload failed")}finally{N(!1)}},A=async({file:s,fileList:r})=>{console.log("FileUpload handleChange called",{file:s,fileList:r.length});const o=(await Promise.all(r.map(async e=>{var m,b,a,l,w,P,v,R;if(e.base64)return e;if(e.status==="done"&&e.response&&((m=e.response.file)!=null&&m.base64))return{...e,url:e.response.file.base64,base64:e.response.file.base64,tempPath:((b=e.response.file)==null?void 0:b.tempPath)||null,fileName:e.name};if(e.originFileObj)try{const x=await M(e.originFileObj);return{...e,url:e.url||URL.createObjectURL(e.originFileObj),base64:x,fileName:e.name,tempPath:e.tempPath||((l=(a=e.response)==null?void 0:a.file)==null?void 0:l.tempPath)||((w=e.response)==null?void 0:w.path)}}catch(x){console.error("Error generating base64 for file:",x)}if(e.url&&!e.base64&&!e.url.startsWith("data:"))try{return{...e,base64:e.url,fileName:e.name,tempPath:e.tempPath||((v=(P=e.response)==null?void 0:P.file)==null?void 0:v.tempPath)||((R=e.response)==null?void 0:R.path)}}catch(x){console.error("Error handling existing file URL:",x)}return e}))).filter(e=>e.status!=="error");f(o);const d=o.map(e=>{var m;return console.log("Processing file for parent:",{name:e.name,tempPath:e.tempPath,status:e.status,hasBase64:!!e.base64,base64Length:e.base64?e.base64.substring(0,30)+"...":null}),{id:(m=e.response)==null?void 0:m.id,isExisting:e.isExisting||!1,tempPath:e.tempPath,url:e.url,base64:e.base64,fileName:e.name,mimeType:e.type||(e.originFileObj?e.originFileObj.type:"image/jpeg"),isDisplay:e.isDisplay||!1,response:e.response}});console.log("Files being sent to parent component:",d.map(e=>({...e,base64:e.base64?`${e.base64.substring(0,30)}...`:null}))),y&&typeof y=="function"&&y(d)},K=async s=>{if(s.isExisting&&n)try{const r=u.filter(c=>c.isDisplay);return r.length===1&&r[0].uid===s.uid?(g.error("មិនអាចលុបកិច្ចសន្យានេះបានទេ ព្រោះវាជាកិច្ចសន្យាតែមួយគត់ដែលបង្ហាញ។ សូមកំណត់កិច្ចសន្យាផ្សេងជាកិច្ចសន្យាបង្ហាញជាមុនសិន។"),!1):(await J.delete(`/api/${p}s/${n}/documents/${s.response.id}`),g.success("កិច្ចសន្យាត្រូវបានលុបដោយជោគជ័យ"),!0)}catch(r){return console.error("Error deleting file:",r),g.error("មានបញ្ហាក្នុងការលុបកិច្ចសន្យា"),!1}return!0},Q=async s=>{var e,m,b;console.log("Setting as display image:",s);const r=u.find(a=>a.uid===s.uid);console.log("Original file data:",r);const c=((m=(e=r==null?void 0:r.response)==null?void 0:e.file)==null?void 0:m.base64)||((b=r==null?void 0:r.url)!=null&&b.startsWith("data:")?r.url:null)||(r==null?void 0:r.base64);console.log("Base64 data found:",!!c);const o=u.map(a=>({...a,isDisplay:a.uid===s.uid}));f(o);const d=o.map(a=>{var w,P,v,R,x,G,_;const l={id:(w=a.response)==null?void 0:w.id,isExisting:a.isExisting||!1,tempPath:((v=(P=a.response)==null?void 0:P.file)==null?void 0:v.tempPath)||((R=a.response)==null?void 0:R.path),url:a.url,base64:((G=(x=a.response)==null?void 0:x.file)==null?void 0:G.base64)||((_=a.url)!=null&&_.startsWith("data:")?a.url:null)||a.base64,fileName:a.name,isDisplay:a.isDisplay,response:a.response};if(a.isDisplay&&(console.log("New file object for display:",l),!l.url||!l.url.startsWith("data:"))){if(l.base64)l.url=l.base64,console.log("Using base64 data as URL for display image");else if(l.tempPath)l.url=`/storage/${l.tempPath}`,console.log("Using tempPath as URL for display image");else if(a.originFileObj&&window.FileReader){const O=new FileReader;O.readAsDataURL(a.originFileObj),O.onload=()=>{const Y=d.map(k=>k.isDisplay?{...k,url:O.result,base64:O.result}:k);console.log("Created base64 URL for display image"),y&&typeof y=="function"&&y(Y)}}}return l});if(console.log("Files being sent to parent component (new):",d),y&&typeof y=="function"&&y(d),s.isExisting&&n)try{await J.put(`/api/${p}s/${n}/documents/${s.response.id}/set-display`),g.success("កិច្ចសន្យាត្រូវបានកំណត់ជាកិច្ចសន្យាបង្ហាញដោយជោគជ័យ")}catch(a){console.error("Error setting display document:",a),g.error("មានបញ្ហាក្នុងការកំណត់កិច្ចសន្យាបង្ហាញ"),f(u)}else g.success("កិច្ចសន្យាត្រូវបានកំណត់ជាកិច្ចសន្យាបង្ហាញដោយជោគជ័យ")},X=t.jsxs("div",{children:[t.jsx(le,{}),t.jsx("div",{style:{marginTop:8},children:"ផ្ទុកឡើង"})]});return t.jsxs("div",{className:"file-upload",children:[t.jsx(pe,{level:5,className:"khmer-heading mb-4",children:"កិច្ចសន្យា"}),t.jsxs(ce,{className:"khmer-text mb-4 block",children:["សូមផ្ទុកឡើងកិច្ចសន្យា (អតិបរមា ",T," កិច្ចសន្យា, ទំហំអតិបរមា ",U,"MB ក្នុងមួយកិច្ចសន្យា)"]}),u.length>0&&t.jsx("div",{style:h.fileGridContainer,children:u.map(s=>s.status==="error"?null:t.jsxs(I,{size:"small",className:`file-card ${s.isDisplay?"border-2 border-blue-500":""}`,style:h.fileCard,styles:{body:{padding:"8px",flex:"1 0 auto"}},cover:t.jsx("div",{style:h.fileCardCover,children:s.type&&s.type.includes("image")?t.jsx("img",{src:s.url||s.originFileObj&&URL.createObjectURL(s.originFileObj),alt:s.name,style:h.filePreviewImage}):t.jsxs("div",{style:h.fileIconContainer,children:[s.type&&s.type.includes("pdf")?t.jsx(ae,{style:{...h.fileIcon,color:"#ff4d4f"}}):t.jsx(ne,{style:{...h.fileIcon,color:"#1890ff"}}),t.jsx("div",{style:h.fileName,children:t.jsx(F,{title:s.name,children:s.name})})]})}),children:[t.jsxs("div",{style:{minHeight:"40px"},children:[t.jsx(F,{title:s.name,children:t.jsx("div",{style:h.fileName,children:s.name})}),s.isDisplay&&t.jsx(ee,{color:"blue",style:h.displayTag,children:"កិច្ចសន្យាបង្ហាញ"})]}),t.jsxs("div",{style:{marginTop:"12px",display:"flex",justifyContent:"space-between"},children:[t.jsx(E,{type:"text",icon:t.jsx(se,{}),onClick:()=>W(s),size:"small"}),t.jsx(F,{title:"កំណត់ជាបង្ហាញ",children:t.jsx(E,{type:s.isDisplay?"primary":"default",icon:t.jsx(te,{}),size:"small",onClick:()=>Q(s),disabled:s.isDisplay,className:"display-button",children:t.jsx("span",{className:"button-text",children:s.isDisplay?"បង្ហាញ":"កំណត់ជាបង្ហាញ"})})}),t.jsx(E,{type:"text",icon:t.jsx(re,{}),danger:!0,size:"small",onClick:()=>{const r=async()=>{if(await K(s)){const o=u.filter(d=>d.uid!==s.uid);f(o),A({fileList:o})}};H.confirm({title:"តើអ្នកពិតជាចង់លុបកិច្ចសន្យានេះមែនទេ?",content:"សកម្មភាពនេះមិនអាចត្រឡប់វិញបានទេ។",okText:"យល់ព្រម",cancelText:"បោះបង់",onOk:r})}})]})]},s.uid))}),t.jsx(ie,{listType:"picture-card",fileList:[],customRequest:q,onChange:A,onPreview:W,multiple:!0,maxCount:T,disabled:B||u.length>=T,accept:".jpg,.jpeg,.png,.pdf",className:"file-upload-button",showUploadList:!1,children:u.length>=T?null:X}),t.jsx(H,{open:V,title:$,footer:null,onCancel:()=>C(!1),children:D&&(D.endsWith(".pdf")?t.jsx("iframe",{src:D,style:{width:"100%",height:"500px"},title:$}):t.jsx("img",{alt:$,style:{width:"100%"},src:D}))}),B&&t.jsx("div",{className:"upload-loading",children:t.jsx(oe,{tip:"កំពុងផ្ទុកឡើង...",size:"large",children:t.jsx("div",{className:"content"})})})]})}export{Le as F};
