import{r as d,d as F,j as e,Q as V,t as X}from"./app-D0OhDuOP.js";import{A as Z,a as ee}from"./AdminLayout-DfyZC7U7.js";import{h}from"./moment-C5S46NFB.js";import{T as se}from"./index-DUD5X347.js";import{S as o}from"./index-CpY42lHj.js";import{R as g}from"./CalendarOutlined-C5Gy31PM.js";import{C as S}from"./index-BXZQm44E.js";import{R as x,C as r}from"./row-Cvvd4www.js";import{S as C,E as te}from"./index-BXlDNFm_.js";import{B as p,T as R}from"./index-XQ9uBlxv.js";import{A as re}from"./index-Ctm2Ggmv.js";import{R as ne}from"./FilePdfOutlined-BmX1d_m5.js";import{R as oe}from"./FileExcelOutlined-BY1VKBUv.js";import{S as le}from"./index-Bjcdw0HM.js";import{R as ae}from"./FolderOutlined-CsvjmU0T.js";import{D as ie}from"./index-BoUcoXbW.js";import{R as ce}from"./FileOutlined-CmtzEeI9.js";import{R as de}from"./UserOutlined-Bw1Yg3TV.js";import{R as xe}from"./DollarOutlined-BgkhO_OZ.js";import{L}from"./index-gO1UGJsN.js";import"./index-BKPGZTnh.js";import"./EllipsisOutlined-BcUT9_x5.js";import"./PurePanel-BrlMViLC.js";import"./EditOutlined-BQAB7wjt.js";import"./getAllowClear-7r21EHJH.js";import"./CloseOutlined-CSg-7HVH.js";import"./useVariants-VmmnPvRy.js";import"./CheckOutlined-C-W3vkf9.js";import"./Skeleton-BB1PfEPR.js";import"./index-BNYa27A7.js";import"./pickAttrs-BMtZpb9Y.js";import"./useIcons-De8HtjeC.js";import"./DownOutlined-BKT6hG3e.js";import"./SearchOutlined-DdbS1Qlk.js";import"./ExclamationCircleFilled-BuCwC-hN.js";import"./InfoCircleFilled-Csbq1HVY.js";import"./extendsObject-78o_rR5W.js";import"./Pagination-C28t5-1k.js";const me={1:"មករា",2:"កុម្ភៈ",3:"មីនា",4:"មេសា",5:"ឧសភា",6:"មិថុនា",7:"កក្កដា",8:"សីហា",9:"កញ្ញា",10:"តុលា",11:"វិច្ឆិកា",12:"ធ្នូ"},Y=b=>{const m=b.month()+1,v=b.year();return`${me[m]} ${v}`},{Title:he,Text:n}=se,pe={backgroundColor:"#fafafa",padding:"12px 16px",borderBottom:"1px solid #f0f0f0",marginBottom:"8px",fontWeight:"bold"},je={background:"#fff",padding:"16px",marginBottom:"8px",borderBottom:"1px solid #f0f0f0"},ye={backgroundColor:"#fff",marginBottom:"24px"},ss=({auth:b})=>{const[m,v]=d.useState(!1),[w,M]=d.useState(!1),[_,$]=d.useState(null),[l,A]=d.useState(null),[z,j]=d.useState(null),[a,y]=d.useState(h()),[i,u]=d.useState(h()),N=h().year(),E=Array.from({length:11},(s,t)=>N-5+t),k=[{value:0,label:"មករា"},{value:1,label:"កុម្ភៈ"},{value:2,label:"មីនា"},{value:3,label:"មេសា"},{value:4,label:"ឧសភា"},{value:5,label:"មិថុនា"},{value:6,label:"កក្កដា"},{value:7,label:"សីហា"},{value:8,label:"កញ្ញា"},{value:9,label:"តុលា"},{value:10,label:"វិច្ឆិកា"},{value:11,label:"ធ្នូ"}],B=()=>[a.clone().startOf("month"),i.clone().endOf("month")],D=d.useCallback(async()=>{const s=B();if(!s||!s[0]||!s[1]){j("សូមជ្រើសរើសកាលបរិច្ឆេទ");return}v(!0),j(null),A(null);try{const t=await F.post("/api/reports/monthly/data",{start_date:s[0].format("YYYY-MM-DD"),end_date:s[1].format("YYYY-MM-DD")});A(t.data)}catch(t){console.error("Error fetching monthly report data:",t),j(t.response&&t.response.data&&t.response.data.error?t.response.data.error:"Failed to fetch report data")}finally{v(!1)}},[a,i]),I=d.useCallback(async s=>{const t=B();if(!t||!t[0]||!t[1]){j("សូមជ្រើសរើសកាលបរិច្ឆេទ");return}M(!0),$(s);try{const c=await F.post("/api/reports/monthly/export",{start_date:t[0].format("YYYY-MM-DD"),end_date:t[1].format("YYYY-MM-DD"),format:s},{responseType:"blob"}),H=window.URL.createObjectURL(new Blob([c.data])),f=document.createElement("a");f.href=H;const J=`monthly_report_${t[0].format("YYYYMMDD")}_to_${t[1].format("YYYYMMDD")}.${s==="excel"?"xlsx":s}`;f.setAttribute("download",J),document.body.appendChild(f),f.click(),document.body.removeChild(f)}catch(c){console.error(`Error exporting report as ${s}:`,c),j(`Failed to export report as ${s}`)}finally{M(!1),$(null)}},[a,i]),O=s=>{const t=a.clone().month(s);y(t)},P=s=>{const t=a.clone().year(s);y(t)},U=s=>{const t=i.clone().month(s);u(t)},Q=s=>{const t=i.clone().year(s);u(t)},K=()=>{const s=h();y(s.clone()),u(s.clone())},W=()=>{const s=h().subtract(1,"month");y(s.clone()),u(s.clone())},q=()=>{const s=h();y(s.clone().startOf("year")),u(s.clone())},G=s=>`ដំណាក់កាលទី ${s}`,T=s=>`$${parseFloat(s).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}`;return d.useEffect(()=>{D()},[D]),e.jsxs(Z,{user:b.user,children:[e.jsx(V,{title:"របាយការណ៍ប្រចាំខែ"}),e.jsxs("div",{className:"monthly-report-container",style:{padding:"24px"},children:[e.jsxs("div",{style:{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:24,borderBottom:"1px solid #f0f0f0",paddingBottom:"12px"},children:[e.jsx(he,{level:2,style:{margin:0},children:"របាយការណ៍ប្រចាំខែ"}),e.jsxs(o,{children:[e.jsx(g,{style:{fontSize:"18px"}}),e.jsx(n,{type:"secondary",style:{fontSize:"14px"},children:`${Y(a)}${!a.isSame(i,"month")||!a.isSame(i,"year")?` - ${Y(i)}`:""}`})]})]}),e.jsx(S,{className:"filter-card",style:{marginBottom:24},title:e.jsxs(o,{children:[e.jsx(g,{}),e.jsx("span",{children:"ជ្រើសរើសខែ"})]}),children:e.jsxs(x,{gutter:16,align:"middle",children:[e.jsxs(r,{xs:24,sm:16,children:[e.jsxs(x,{gutter:16,children:[e.jsxs(r,{xs:24,md:12,children:[e.jsx("div",{className:"mb-2",children:e.jsx(n,{type:"secondary",children:"ខែចាប់ផ្តើម"})}),e.jsxs(x,{gutter:8,children:[e.jsx(r,{span:12,children:e.jsx(C,{style:{width:"100%"},value:a.month(),onChange:O,options:k})}),e.jsx(r,{span:12,children:e.jsx(C,{style:{width:"100%"},value:a.year(),onChange:P,options:E.map(s=>({value:s,label:s}))})})]})]}),e.jsxs(r,{xs:24,md:12,children:[e.jsx("div",{className:"mb-2",children:e.jsx(n,{type:"secondary",children:"ខែបញ្ចប់"})}),e.jsxs(x,{gutter:8,children:[e.jsx(r,{span:12,children:e.jsx(C,{style:{width:"100%"},value:i.month(),onChange:U,options:k})}),e.jsx(r,{span:12,children:e.jsx(C,{style:{width:"100%"},value:i.year(),onChange:Q,options:E.map(s=>({value:s,label:s}))})})]})]})]}),e.jsx("div",{style:{marginTop:16},children:e.jsxs(o,{children:[e.jsx(p,{size:"small",onClick:K,children:"ខែបច្ចុប្បន្ន"}),e.jsx(p,{size:"small",onClick:W,children:"ខែមុន"}),e.jsx(p,{size:"small",onClick:q,children:"ឆ្នាំនេះ"})]})})]}),e.jsx(r,{xs:24,sm:8,style:{textAlign:"right",marginTop:{xs:16,sm:0}},children:e.jsx(p,{type:"primary",onClick:D,loading:m,icon:e.jsx(g,{}),children:"បង្កើតរបាយការណ៍"})})]})}),z&&e.jsx(re,{message:z,type:"error",showIcon:!0,style:{marginBottom:24}}),l&&!m&&l.payments&&l.payments.length>0&&e.jsx(S,{style:{marginBottom:16},children:e.jsxs(x,{justify:"space-between",align:"middle",children:[e.jsx(r,{children:e.jsxs(n,{strong:!0,children:[e.jsx(g,{})," របាយការណ៍សម្រាប់: ",Y(a)," - ",Y(i)]})}),e.jsx(r,{children:e.jsxs(o,{children:[e.jsx(R,{title:"នាំចេញជា PDF",children:e.jsx(p,{type:"primary",icon:e.jsx(ne,{}),onClick:()=>I("pdf"),loading:w&&_==="pdf",danger:!0,children:"PDF"})}),e.jsx(R,{title:"នាំចេញជា Excel",children:e.jsx(p,{type:"primary",style:{backgroundColor:"#52c41a"},icon:e.jsx(oe,{}),onClick:()=>I("excel"),loading:w&&_==="excel",children:"Excel"})})]})})]})}),m&&e.jsxs(S,{style:{textAlign:"center",padding:"40px 0"},children:[e.jsx(le,{size:"large"}),e.jsx("p",{style:{marginTop:16},children:"កំពុងបង្កើតរបាយការណ៍..."})]}),!m&&(!l||!l.payments||l.payments.length===0)&&e.jsxs(S,{style:{textAlign:"center",padding:"20px 0"},children:[e.jsx(te,{description:e.jsx(n,{style:{fontSize:"16px"},children:"មិនមានទិន្នន័យសម្រាប់ខែដែលបានជ្រើសរើស"}),image:e.jsx(ae,{style:{fontSize:60,color:"#ccc"}})}),e.jsx(ie,{dashed:!0}),e.jsx(n,{type:"secondary",children:"សូមជ្រើសរើសខែផ្សេងឬពិនិត្យមើលថាតើមានទិន្នន័យសម្រាប់ខែនេះឬអត់"})]}),!m&&l&&l.payments&&l.payments.length>0&&e.jsxs("div",{style:ye,children:[e.jsxs(x,{gutter:16,style:pe,children:[e.jsx(r,{xs:24,sm:6,md:4,children:e.jsxs(o,{children:[e.jsx(ce,{}),e.jsx(n,{children:"លេខកុងត្រា"})]})}),e.jsx(r,{xs:24,sm:6,md:4,children:e.jsxs(o,{children:[e.jsx(ee,{}),e.jsx(n,{children:"លេខដី"})]})}),e.jsx(r,{xs:24,sm:12,md:6,children:e.jsxs(o,{children:[e.jsx(de,{}),e.jsx(n,{children:"អ្នកលក់/អ្នកទិញ"})]})}),e.jsx(r,{xs:24,sm:12,md:5,children:e.jsxs(o,{children:[e.jsx(g,{}),e.jsx(n,{children:"ដំណាក់កាល"})]})}),e.jsx(r,{xs:24,sm:12,md:5,style:{textAlign:"right",paddingRight:"24px"},children:e.jsxs(o,{children:[e.jsx(xe,{}),e.jsx(n,{children:"ចំនួនទឹកប្រាក់"})]})})]}),e.jsx(L,{itemLayout:"horizontal",dataSource:l.payments,renderItem:s=>e.jsx(L.Item,{style:je,children:e.jsxs(x,{gutter:16,style:{width:"100%"},children:[e.jsx(r,{xs:24,sm:6,md:4,children:e.jsx(X,{href:`/reports/document?contract_id=${s.contract_id}`,className:"text-blue-600 hover:text-blue-800 font-bold",children:s.contract_id})}),e.jsx(r,{xs:24,sm:6,md:4,children:Array.isArray(s.lands)&&s.lands.length>0?e.jsx(o,{direction:"vertical",size:"small",style:{width:"100%"},children:s.lands.map((t,c)=>e.jsx("span",{children:t.plot_number},c))}):s.land_plot_number?e.jsx("span",{children:s.land_plot_number}):e.jsx("span",{children:"-"})}),e.jsx(r,{xs:24,sm:12,md:6,children:e.jsxs(o,{direction:"vertical",size:"small",style:{width:"100%"},children:[Array.isArray(s.sellers)&&s.sellers.length>0?e.jsxs("div",{children:[e.jsx(n,{type:"secondary",style:{fontSize:"12px"},children:"អ្នកលក់:"}),e.jsx("div",{children:s.sellers.map((t,c)=>e.jsx(R,{title:t.full_info,children:e.jsxs("span",{children:[c>0?", ":"",t.name]})},c))})]}):e.jsxs("div",{children:[e.jsx(n,{type:"secondary",style:{fontSize:"12px"},children:"អ្នកលក់:"}),e.jsx("div",{children:s.seller_names||"-"})]}),Array.isArray(s.buyers)&&s.buyers.length>0?e.jsxs("div",{children:[e.jsx(n,{type:"secondary",style:{fontSize:"12px"},children:"អ្នកទិញ:"}),e.jsx("div",{children:s.buyers.map((t,c)=>e.jsx(R,{title:t.full_info,children:e.jsxs("span",{children:[c>0?", ":"",t.name]})},c))})]}):e.jsxs("div",{children:[e.jsx(n,{type:"secondary",style:{fontSize:"12px"},children:"អ្នកទិញ:"}),e.jsx("div",{children:s.buyer_names||"-"})]})]})}),e.jsx(r,{xs:24,sm:12,md:5,children:G(s.step_number)}),e.jsx(r,{xs:24,sm:12,md:5,style:{textAlign:"right",paddingRight:"24px"},children:e.jsx(n,{strong:!0,children:T(s.amount)})})]})})}),e.jsxs(x,{children:[e.jsx(r,{xs:0,sm:0,md:19}),e.jsx(r,{xs:24,sm:12,md:5,style:{textAlign:"right",marginTop:16,paddingRight:"24px"},children:e.jsxs(o,{children:[e.jsx(n,{type:"secondary",style:{fontSize:"16px"},children:"ចំនួនសរុប:"}),e.jsx(n,{strong:!0,style:{fontSize:"18px"},children:T(l.summary.total_amount)})]})})]})]})]})]})};export{ss as default};
